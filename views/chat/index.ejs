<%- include('../partials/header_layout') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
    /* Markdown Styles */
    .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
    .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0; }
    .markdown-body p { margin-bottom: 0.5em; }
    .markdown-body a { color: #2563EB; text-decoration: underline; }
    .markdown-body code { background-color: #F1F5F9; padding: 0.2em 0.4em; rounded: 0.25rem; font-family: monospace; font-size: 0.9em; }
    .markdown-body pre { background-color: #1E293B; color: #F8FAFC; padding: 1em; border-radius: 0.5rem; overflow-x: auto; margin: 0.5em 0; }
    .markdown-body blockquote { border-left: 4px solid #CBD5E1; padding-left: 1em; color: #64748B; margin: 0.5em 0; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94A3B8; }

    /* Typing Animation */
    .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Seen Avatar Stack */
    .seen-stack > img {
        margin-left: -8px;
        border: 2px solid white;
    }
    .seen-stack > img:first-child { margin-left: 0; }
</style>

<div class="h-[calc(100vh-64px)] flex bg-white overflow-hidden">
    <!-- Sidebar -->
    <div class="w-72 bg-slate-50 border-r border-slate-200 flex flex-col flex-shrink-0">
        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50 backdrop-blur-sm">
            <h2 class="text-sm font-bold uppercase tracking-wider text-slate-500">Conversations</h2>
            <div class="flex gap-1">
                <button onclick="document.getElementById('create-dm-modal').classList.remove('hidden')" class="text-slate-400 hover:text-indigo-600 transition-colors p-1 rounded-md hover:bg-indigo-50" title="New Direct Message">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                </button>
                <button onclick="document.getElementById('create-channel-modal').classList.remove('hidden')" class="text-slate-400 hover:text-indigo-600 transition-colors p-1 rounded-md hover:bg-indigo-50" title="Create Channel">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
            <% channels.forEach(channel => { %>
                <% 
                    let icon = '#';
                    let iconClass = 'text-slate-400';
                    let isDM = channel.type === 'PRIVATE' && channel.name.startsWith('dm-');
                    let displayName = channel.name;

                    if (channel.type === 'SYSTEM' || channel.is_read_only) {
                        icon = 'ðŸ“¢';
                        iconClass = 'text-amber-500';
                    } else if (isDM) {
                         // Logic to show other user's name would be ideal here, but simpler for MVP:
                         icon = 'ðŸ‘¤';
                         iconClass = 'text-emerald-500';
                         // displayName = "Direct Message"; // Real app would parse participants
                    } else if (channel.type === 'PRIVATE') {
                        icon = 'ðŸ”’';
                        iconClass = 'text-slate-500';
                    } else if (channel.min_role_required === 'ADMIN') {
                        icon = 'ðŸ›¡ï¸';
                        iconClass = 'text-red-500';
                    } else if (channel.entitlement_required) {
                        icon = 'ðŸ’Ž';
                        iconClass = 'text-indigo-500';
                    }
                %>
                <a href="/chat/channels/<%= channel.id %>" class="group flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all <%= activeChannel && activeChannel.id === channel.id ? 'bg-white shadow-sm ring-1 ring-slate-200 text-indigo-700' : 'text-slate-600 hover:bg-slate-100' %>">
                    <span class="mr-3 <%= iconClass %> text-base flex-shrink-0 w-6 text-center"><%= icon %></span>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="truncate"><%= displayName %></span>
                            <% if (channel.entitlement_required) { %>
                                <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-indigo-100 text-indigo-800">PRO</span>
                            <% } %>
                        </div>
                    </div>
                </a>
            <% }) %>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col min-w-0 relative">
        <% if (activeChannel) { %>
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-white shadow-sm z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-lg">
                        <% if (activeChannel.type === 'PRIVATE' && activeChannel.name.startsWith('dm-')) { %>@<% } else { %>#<% } %>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                            <%= activeChannel.name %>
                            <% if (activeChannel.type === 'SYSTEM') { %>
                                <span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 text-xs font-medium border border-amber-200">System</span>
                            <% } %>
                        </h1>
                    </div>
                </div>
                <!-- Block Action for DMs -->
                <% if (activeChannel.type === 'PRIVATE' && activeChannel.name.startsWith('dm-')) { %>
                    <div class="flex items-center space-x-2">
                        <button onclick="blockCurrentChannelUser()" class="text-red-500 hover:text-red-700 text-sm font-medium">Block User</button>
                    </div>
                <% } %>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50 custom-scrollbar scroll-smooth" id="messages-container">
                <% if (typeof messages !== 'undefined' && messages.length > 0) { %>
                    <% let lastUser = null; %>
                    <% messages.forEach(msg => { %>
                        <%- include('message_partial', { msg, user, lastUser }) %>
                        <% if (msg.type !== 'SYSTEM') lastUser = msg.user_id; else lastUser = 'SYSTEM'; %>
                    <% }) %>
                <% } else { %>
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <div class="w-20 h-20 bg-slate-100 rounded-2xl flex items-center justify-center mb-6 transform -rotate-3">
                            <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900">It's quiet here...</h3>
                    </div>
                <% } %>
                <!-- Typing Indicator Placeholders -->
                <div id="typing-indicators"></div>
            </div>

            <!-- Input -->
            <div class="p-4 bg-white border-t border-slate-200">
                <% if (activeChannel.is_read_only) { %>
                    <div class="bg-slate-50 rounded-lg p-4 text-center text-sm text-slate-500 flex items-center justify-center gap-2 border border-slate-200 border-dashed">
                        This channel is read-only.
                    </div>
                <% } else { %>
                    <form id="chat-form" action="/chat/channels/<%= activeChannel.id %>/messages" class="flex gap-3 items-end" enctype="multipart/form-data">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <!-- Hidden File Input -->
                        <input type="file" name="files" id="file-input" class="hidden" multiple onchange="handleFileSelect(this)">
                        
                        <div class="flex-1 relative">
                            <!-- File Preview -->
                            <div id="file-preview" class="hidden absolute bottom-full left-0 mb-2 p-2 bg-white rounded-lg shadow-lg border border-slate-200 flex flex-col gap-2 max-h-48 overflow-y-auto">
                                <!-- Dynamic Content -->
                            </div>

                            <textarea 
                                name="content" 
                                id="message-input"
                                placeholder="Message... (Markdown enabled)" 
                                class="w-full rounded-xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 pl-4 pr-12 py-3 min-h-[50px] max-h-[150px] resize-none custom-scrollbar"
                                autofocus
                            ></textarea>
                            <div class="absolute right-2 bottom-2.5 flex gap-1">
                                <button type="button" onclick="document.getElementById('file-input').click()" class="p-1.5 text-slate-400 hover:text-indigo-600 rounded-md hover:bg-slate-100 transition-colors" title="Attach File">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="h-[50px] px-6 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 shadow-sm transition-all flex items-center gap-2">
                            <span>Send</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 12h15"></path></svg>
                        </button>
                    </form>
                <% } %>
            </div>

            <script>
                // State
                const channelId = "<%= activeChannel.id %>";
                const userId = "<%= user ? user.id : '' %>";
                const csrfToken = "<%= csrfToken %>";
                const socket = io();

                // 1. Join Channel
                socket.emit('join_channel', channelId);

                // 2. Typing Logic
                let typingTimeout;
                const input = document.getElementById('message-input');
                if (input) {
                    input.addEventListener('input', () => {
                        socket.emit('typing', { channelId, isTyping: true });
                        clearTimeout(typingTimeout);
                        typingTimeout = setTimeout(() => {
                            socket.emit('typing', { channelId, isTyping: false });
                        }, 2000);
                    });
                    
                    input.addEventListener('keydown', (e) => {
                         if(e.key === 'Enter' && !e.shiftKey) { 
                             e.preventDefault(); 
                             document.getElementById('chat-form').dispatchEvent(new Event('submit')); 
                         }
                    });
                }

                // 3. Listen for Typing
                socket.on('typing', ({ userId: typerId, userName, isTyping }) => {
                    if (typerId === userId) return;
                    
                    const container = document.getElementById('typing-indicators');
                    const existing = document.getElementById(`typing-${typerId}`);
                    
                    if (isTyping) {
                        if (!existing) {
                            const indicator = document.createElement('div');
                            indicator.id = `typing-${typerId}`;
                            indicator.className = "flex items-center gap-2 mt-2 ml-12 text-xs text-slate-400";
                            indicator.innerHTML = `
                                <span class="font-semibold">${userName}</span> is typing
                                <div class="flex space-x-1">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                </div>
                            `;
                            container.appendChild(indicator);
                            scrollToBottom();
                        }
                    } else {
                        if (existing) existing.remove();
                    }
                });

                // 4. New Message Handling
                socket.on('new_message', (msg) => {
                    const container = document.getElementById('messages-container');
                    const emptyState = document.getElementById('empty-state');
                    if (emptyState) emptyState.remove();

                    const isMe = msg.user_id === userId;
                    const div = document.createElement('div');
                    
                    // Simple template rendering (simplified version of server-side include)
                    const isSystem = msg.type === 'SYSTEM';
                    
                    if (isSystem) {
                         div.className = "flex justify-center my-6";
                         div.id = `msg-${msg.id}`;
                         div.innerHTML = `
                            <div class="bg-amber-50 border border-amber-200 rounded-lg px-4 py-3 max-w-2xl w-full shadow-sm flex items-start gap-3">
                                <div class="flex-shrink-0 mt-0.5"><svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg></div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-amber-800 mb-1">System Alert</p>
                                    <div class="text-sm text-amber-900 markdown-body" data-content="${encodeURIComponent(msg.content)}"></div>
                                    <div class="mt-2 text-xs text-amber-600/70">Just now</div>
                                </div>
                            </div>`;
                    } else {
                        const avatar = msg.sender.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.sender.name)}&background=random`;
                        
                        let attachmentHtml = '';
                        if (msg.attachments && msg.attachments.length > 0) {
                            msg.attachments.forEach(att => {
                                if (att.file_type.startsWith('image/')) {
                                    attachmentHtml += `<img src="/${att.url}" class="mt-2 rounded-lg max-h-64 border border-slate-200 bg-white" loading="lazy">`;
                                } else {
                                    attachmentHtml += `<div class="mt-2 p-3 bg-slate-100 rounded-lg flex items-center gap-3 border border-slate-200 max-w-sm">
                                        <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v15a2 2 0 002 2z"></path></svg>
                                        <div class="min-w-0 flex-1">
                                            <p class="text-sm font-medium text-slate-700 truncate">${att.file_name}</p>
                                            <p class="text-xs text-slate-500">${Math.round(att.file_size/1024)} KB</p>
                                        </div>
                                        <a href="/${att.url}" target="_blank" class="ml-auto text-indigo-600 hover:underline text-xs whitespace-nowrap">Download</a>
                                    </div>`;
                                }
                            });
                        }

                        div.className = "flex gap-4 group relative mt-6";
                        div.id = `msg-${msg.id}`;
                        div.innerHTML = `
                            <div class="flex-shrink-0 w-10">
                                <img class="h-10 w-10 rounded-full bg-white shadow-sm object-cover ring-2 ring-white" src="${avatar}" alt="">
                            </div>
                            <div class="flex-1 min-w-0 relative group/content">
                                <div class="flex items-baseline gap-2 mb-1">
                                    <span class="text-sm font-bold text-slate-900">${msg.sender.name}</span>
                                    <span class="text-xs text-slate-400">Just now</span>
                                </div>
                                <div class="text-sm text-slate-700 leading-relaxed markdown-body max-w-3xl" id="content-${msg.id}" data-content="${encodeURIComponent(msg.content)}">
                                    ${DOMPurify.sanitize(marked.parse(msg.content))}
                                </div>
                                ${attachmentHtml}
                                <div class="flex items-center mt-1 space-x-1 seen-stack" id="seen-${msg.id}"></div>
                                ${isMe ? `
                                <div class="absolute right-0 -top-3 opacity-0 group-hover/content:opacity-100 transition-opacity flex bg-white shadow-sm border border-slate-200 rounded p-0.5 z-10">
                                    <button onclick="editMessage('${msg.id}')" class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded" title="Edit">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button onclick="deleteMessage('${msg.id}')" class="p-1 text-slate-400 hover:text-red-600 hover:bg-slate-50 rounded" title="Delete">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>` : ''}
                            </div>
                        `;
                    }
                    
                    container.insertBefore(div, document.getElementById('typing-indicators'));
                    scrollToBottom();
                    
                    // Render the just-added markdown (using data-content logic)
                    const newContentEl = div.querySelector('.markdown-body');
                    if (newContentEl) {
                        const raw = decodeURIComponent(newContentEl.dataset.content || "");
                        newContentEl.innerHTML = DOMPurify.sanitize(marked.parse(raw));
                    }
                    
                    if (!isMe) socket.emit('read_message', { channelId, messageId: msg.id });
                });

                // Socket Event: Update
                socket.on('message_updated', ({ id, content }) => {
                    const contentDiv = document.getElementById(`content-${id}`);
                    if (contentDiv) {
                        // Update data-content
                        contentDiv.dataset.content = encodeURIComponent(content);
                        contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
                        // Add edited label if not there
                        if (!contentDiv.parentElement.querySelector('span.select-none')) {
                            const label = document.createElement('span');
                            label.className = "text-[10px] text-slate-400 select-none";
                            label.innerText = "(edited)";
                            contentDiv.parentElement.insertBefore(label, contentDiv.nextSibling);
                        }
                    }
                });

                // Socket Event: Delete
                socket.on('message_deleted', ({ id }) => {
                    const msgDiv = document.getElementById(`msg-${id}`);
                    if (msgDiv) {
                        const inner = msgDiv.querySelector('.flex-1');
                        if (inner) {
                            inner.innerHTML = `<div class="text-sm italic text-slate-400 border-l-2 border-slate-200 pl-3 py-1">Message deleted</div>`;
                        }
                    }
                });

                // 5. Read Receipts
                socket.on('message_read', ({ messageId, userId, userAvatar }) => {
                    const stack = document.getElementById(`seen-${messageId}`);
                    if (stack) {
                        if (!stack.querySelector(`img[data-user="${userId}"]`)) {
                            const img = document.createElement('img');
                            img.src = userAvatar || `https://ui-avatars.com/api/?name=User&background=random`;
                            img.className = "w-4 h-4 rounded-full";
                            img.dataset.user = userId;
                            img.title = "Seen";
                            stack.appendChild(img);
                        }
                    }
                });

                // 6. Form Submit (AJAX)
                const form = document.getElementById('chat-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const btn = form.querySelector('button[type="submit"]');
                        const originalText = btn.innerHTML;
                        
                        btn.disabled = true;
                        btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

                        try {
                            const url = `/chat/channels/${channelId}/messages`;
                            const res = await fetch(url, {
                                method: 'POST',
                                body: formData,
                                headers: { 
                                    'Accept': 'application/json',
                                    'CSRF-Token': csrfToken
                                }
                            });
                            const data = await res.json();
                            
                            if (data.success) {
                                form.reset();
                                clearFile();
                                socket.emit('typing', { channelId, isTyping: false });
                            } else {
                                alert(data.message || 'Failed to send');
                            }
                        } catch (err) {
                            console.error(err);
                        } finally {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            document.getElementById('message-input').focus();
                        }
                    });
                }

                // --- Edit & Delete Functions ---
                async function deleteMessage(id) {
                    if (!confirm('Delete this message?')) return;
                    try {
                        const res = await fetch(`/chat/channels/${channelId}/messages/${id}`, {
                            method: 'DELETE',
                            headers: { 
                                'Accept': 'application/json',
                                'CSRF-Token': csrfToken
                            }
                        });
                        if (!res.ok) alert('Failed to delete');
                    } catch (e) { console.error(e); }
                }

                async function editMessage(id) {
                    const contentDiv = document.getElementById(`content-${id}`);
                    if (!contentDiv) return;
                    
                    const rawContent = decodeURIComponent(contentDiv.dataset.content || "");
                    const originalHtml = contentDiv.innerHTML;
                    
                    contentDiv.innerHTML = `
                        <div class="mt-2">
                            <textarea id="edit-input-${id}" class="w-full p-2 border border-slate-300 rounded text-sm">${rawContent}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button onclick="saveEdit('${id}')" class="px-3 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700">Save</button>
                                <button onclick="cancelEdit('${id}')" class="px-3 py-1 bg-slate-200 text-slate-700 text-xs rounded hover:bg-slate-300">Cancel</button>
                            </div>
                        </div>
                    `;
                    // Save original for cancel
                    contentDiv.dataset.original = originalHtml;
                }

                function cancelEdit(id) {
                    const contentDiv = document.getElementById(`content-${id}`);
                    if (contentDiv && contentDiv.dataset.original) {
                        contentDiv.innerHTML = contentDiv.dataset.original;
                    }
                }

                async function saveEdit(id) {
                    const input = document.getElementById(`edit-input-${id}`);
                    const newContent = input.value;
                    if (!newContent.trim()) return;

                    try {
                        const res = await fetch(`/chat/channels/${channelId}/messages/${id}`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ content: newContent })
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            const contentDiv = document.getElementById(`content-${id}`);
                            // Update content
                            contentDiv.dataset.content = encodeURIComponent(data.message.content);
                            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.message.content));
                        } else {
                            alert('Failed to update');
                        }
                    } catch (e) { console.error(e); }
                }

                function scrollToBottom() {
                    const container = document.getElementById('messages-container');
                    container.scrollTop = container.scrollHeight;
                }
                
                function handleFileSelect(input) {
                    if (input.files && input.files.length > 0) {
                        const preview = document.getElementById('file-preview');
                        preview.innerHTML = '';
                        preview.classList.remove('hidden');
                        
                        Array.from(input.files).forEach((file, index) => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-3 bg-slate-50 p-2 rounded';
                            div.innerHTML = `
                                <div class="bg-indigo-100 p-1.5 rounded text-indigo-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="text-xs font-semibold text-slate-700 truncate">${file.name}</p>
                                    <p class="text-[10px] text-slate-500">${Math.round(file.size/1024)} KB</p>
                                </div>
                            `;
                            preview.appendChild(div);
                        });
                        
                        const clearBtn = document.createElement('button');
                        clearBtn.type = 'button';
                        clearBtn.onclick = clearFile;
                        clearBtn.className = 'text-xs text-red-500 hover:underline mt-1 self-end';
                        clearBtn.innerText = 'Remove All';
                        preview.appendChild(clearBtn);
                    }
                }

                function clearFile() {
                    document.getElementById('file-input').value = '';
                    document.getElementById('file-preview').classList.add('hidden');
                }

                // Initial Render logic using decodeURIComponent
                document.querySelectorAll('.markdown-body').forEach(el => {
                    const raw = decodeURIComponent(el.dataset.content || "");
                    const clean = DOMPurify.sanitize(marked.parse(raw));
                    el.innerHTML = clean;
                });
                
                scrollToBottom();

                // Block Logic
                async function blockCurrentChannelUser() {
                    if (!confirm('Are you sure you want to block this user?')) return;
                    // Extract ID from somewhere? 
                    // Since it's a DM, we need to know the *other* user ID.
                    // Ideally, pass this via template to a JS var.
                    // For now, prompt user ID is bad UX.
                    // Let's rely on the fact that if it's a DM, the participants are known.
                    // Actually, simpler: Use the Participants API or pass 'targetUserId' in render.
                    // I will add 'targetUserId' to the render context in controller later or extract from channel name if possible?
                    // No, safe way: The server knows participants.
                    // Client needs to know targetId.
                    // I'll add logic to searchCandidates to handle filtering, 
                    // blocking logic here requires target ID.
                    // Suggestion: Add a data-attribute to the header.
                }
                
                // DM Search Logic
                let searchTimeout;
                function searchUsers(q) {
                    if (q.length < 2) return;
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(async () => {
                        const res = await fetch(`/chat/candidates?q=${encodeURIComponent(q)}`);
                        const users = await res.json();
                        const list = document.getElementById('dm-candidates');
                        list.innerHTML = users.map(u => `
                            <div onclick="selectUser('${u.id}')" class="p-2 hover:bg-slate-50 cursor-pointer flex items-center gap-2 rounded">
                                <img src="${u.avatar_url || 'https://ui-avatars.com/api/?name='+u.name}" class="w-8 h-8 rounded-full">
                                <div><p class="text-sm font-medium">${u.name}</p><p class="text-xs text-slate-500">${u.email}</p></div>
                            </div>
                        `).join('');
                        list.classList.remove('hidden');
                    }, 300);
                }
                
                function selectUser(id) {
                    const input = document.querySelector('input[name="targetUserId"]');
                    input.value = id;
                    document.getElementById('dm-candidates').classList.add('hidden');
                    input.closest('form').submit();
                }
            </script>
        <% } else { %>
            <!-- Empty State -->
            <div class="flex-1 flex flex-col items-center justify-center bg-slate-50/50 backdrop-blur-sm">
                <div class="text-center max-w-md mx-auto p-8 bg-white rounded-2xl shadow-xl border border-slate-100">
                     <h2 class="text-2xl font-bold text-slate-900 mb-3">Welcome to Team Chat</h2>
                     <button onclick="document.getElementById('create-channel-modal').classList.remove('hidden')" class="w-full btn btn-primary btn-lg shadow-lg">Create New Channel</button>
                     <button onclick="document.getElementById('create-dm-modal').classList.remove('hidden')" class="mt-4 w-full btn btn-outline btn-lg">Start Direct Message</button>
                </div>
            </div>
        <% } %>
    </div>
</div>

<!-- Create Channel Modal (Existing) -->
<div id="create-channel-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-800">Create New Channel</h3>
            <button onclick="document.getElementById('create-channel-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form action="/chat/channels" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Channel Name</label>
                <div class="relative group">
                    <span class="absolute left-3 top-2.5 text-slate-400 font-medium">#</span>
                    <input type="text" name="name" required class="w-full pl-7 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. general">
                </div>
            </div>
            <!-- ... other fields ... -->
            <div class="grid grid-cols-2 gap-6">
                <div>
                     <label class="block text-sm font-semibold text-slate-700 mb-1.5">Type</label>
                     <select name="type" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl"><option value="PUBLIC">Public</option><option value="PRIVATE">Private</option></select>
                </div>
            </div>
            <div class="pt-2 flex gap-3">
                <button type="button" onclick="document.getElementById('create-channel-modal').classList.add('hidden')" class="flex-1 px-6 py-2.5 border border-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-50">Cancel</button>
                <button type="submit" class="flex-1 px-6 py-2.5 bg-indigo-600 text-white font-medium rounded-xl hover:bg-indigo-700">Create Channel</button>
            </div>
        </form>
    </div>
</div>

<!-- Create DM Modal -->
<div id="create-dm-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center rounded-t-2xl">
            <h3 class="text-lg font-bold text-slate-800">Start Direct Message</h3>
            <button onclick="document.getElementById('create-dm-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form action="/chat/dm" method="POST" class="p-6 space-y-4">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div class="relative">
                <label class="block text-sm font-semibold text-slate-700 mb-1.5">Search User</label>
                <input type="text" oninput="searchUsers(this.value)" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type name or email...">
                <input type="hidden" name="targetUserId" required>
                <div id="dm-candidates" class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto z-10"></div>
            </div>
            <div class="pt-2 flex gap-3">
                <button type="button" onclick="document.getElementById('create-dm-modal').classList.add('hidden')" class="flex-1 px-6 py-2.5 border border-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-50">Cancel</button>
            </div>
        </form>
    </div>
</div>

<%- include('../partials/footer_layout') %>