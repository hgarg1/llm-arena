<script>
    window.toastManager = function() {
        return {
            toasts: [],
            queue: [],
            lastToastTime: 0,
            rateLimit: <%= (user && user.chat_notifications_rate_limit) ? (user.chat_notifications_rate_limit * 1000) : 5000 %>,
            notificationsEnabled: <%= (user && user.chat_notifications_enabled === true) ? 'true' : 'false' %>,

            init() {
                if (this.notificationsEnabled) {
                    this.startPolling();
                }
            },

            async startPolling() {
                setInterval(async () => {
                    try {
                        const resp = await fetch('/chat/notifications/poll');
                        const data = await resp.json();
                        if (data.notifications && data.notifications.length > 0) {
                            data.notifications.forEach(n => this.add(n));
                        }
                    } catch (e) {
                        // ignore poll errors
                    }
                }, 10000); // Poll every 10s
            },

            add(detail) {
                this.queue.push({
                    id: Date.now() + Math.random(),
                    type: detail.type || 'info',
                    title: detail.title || 'Notification',
                    message: detail.message || '',
                    visible: false
                });
                this.processQueue();
            },

            processQueue() {
                if (this.queue.length === 0) return;

                const now = Date.now();
                const timeSinceLast = now - this.lastToastTime;

                if (timeSinceLast >= this.rateLimit) {
                    const toast = this.queue.shift();
                    toast.visible = true;
                    this.toasts.push(toast);
                    this.lastToastTime = now;

                    setTimeout(() => {
                        this.remove(toast.id);
                    }, 5000);

                    // If more in queue, schedule next check
                    if (this.queue.length > 0) {
                        setTimeout(() => this.processQueue(), this.rateLimit);
                    }
                } else {
                    // Not ready yet, check again after remaining time
                    setTimeout(() => this.processQueue(), this.rateLimit - timeSinceLast);
                }
            },

            remove(id) {
                const index = this.toasts.findIndex(t => t.id === id);
                if (index > -1) {
                    this.toasts[index].visible = false;
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 300);
                }
            }
        }
    }
</script>

<div 
    x-data="toastManager()" 
    @toast.window="add($event.detail)"
    class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 w-full max-w-sm pointer-events-none"
>
    <template x-for="toast in toasts" :key="toast.id">
        <div 
            x-show="toast.visible"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="translate-y-2 opacity-0"
            x-transition:enter-end="translate-y-0 opacity-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="pointer-events-auto bg-white rounded-lg shadow-lg border border-border p-4 flex items-start gap-3 relative overflow-hidden"
            :class="{'border-l-4 border-l-indigo-500': toast.type === 'chat'}"
        >
            <div class="flex-shrink-0 mt-0.5">
                <template x-if="toast.type === 'chat'">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                </template>
                <template x-if="toast.type !== 'chat'">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </template>
            </div>
            <div class="flex-1 min-w-0">
                <p x-text="toast.title" class="text-sm font-bold text-primary truncate"></p>
                <p x-text="toast.message" class="text-xs text-secondary line-clamp-2"></p>
            </div>
            <button @click="remove(toast.id)" class="text-slate-400 hover:text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <!-- Progress bar for auto-hide -->
            <div class="absolute bottom-0 left-0 h-0.5 bg-slate-100 w-full">
                <div 
                    class="h-full bg-indigo-500/20 transition-all duration-[5000ms] ease-linear"
                    :style="{ width: toast.visible ? '0%' : '100%' }"
                ></div>
            </div>
        </div>
    </template>
</div>