<%- include('../partials/header_layout') %>
    <div x-data="replayViewer('<%= match.id %>')" x-init="init()" class="flex flex-col h-[calc(100vh-60px)]">
        
        <!-- Toolbar -->
        <div class="border-b border-border bg-white px-6 py-3 flex justify-between items-center shadow-sm z-10">
            <div class="flex items-center gap-4">
                <a href="/matches" class="text-secondary hover:text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></svg>
                </a>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Match Replay</h1>
                    <div class="text-xs font-mono text-secondary"><%= match.id %></div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                <button @click="reset()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" title="Reset">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path><path d="M3 3v9h9"></svg>
                </button>
                <button @click="prev()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" :disabled="currentIndex <= 0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></svg>
                </button>
                <button @click="togglePlay()" class="btn btn-sm btn-white bg-white text-primary shadow min-w-[80px] font-medium" x-text="isPlaying ? 'Pause' : 'Play'"></button>
                <button @click="next()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" :disabled="currentIndex >= events.length - 1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"></svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow flex overflow-hidden bg-gray-50">
            
            <!-- Transcript (Center/Left) -->
            <div class="flex-1 overflow-y-auto p-6 flex flex-col items-center" id="transcript">
                <div class="w-full max-w-3xl space-y-6 pb-12">
                    <template x-for="(event, index) in visibleEvents" :key="event.id">
                        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300">
                            <!-- System Message -->
                            <div x-show="event.actor_role === 'system'" class="flex justify-center my-4">
                                <span class="bg-gray-200 text-gray-600 text-xs font-mono px-3 py-1 rounded-full uppercase tracking-wide" x-text="getEventText(event)"></span>
                            </div>

                            <!-- Player Message -->
                            <div x-show="event.actor_role !== 'system'"
                                 class="flex gap-4"
                                 :class="{'flex-row-reverse': event.actor_role === 'player2'}">
                                
                                <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-xs font-bold shadow-sm"
                                     :class="{'bg-blue-100 text-blue-700': event.actor_role === 'player1', 'bg-emerald-100 text-emerald-700': event.actor_role === 'player2'}">
                                     <span x-text="event.actor_role === 'player1' ? 'P1' : 'P2'"></span>
                                </div>

                                <div class="max-w-[80%]">
                                    <div class="text-xs text-secondary mb-1 px-1"
                                         :class="{'text-right': event.actor_role === 'player2'}">
                                        <span class="font-medium" x-text="event.actor_role === 'player1' ? 'Player 1' : 'Player 2'"></span>
                                        <span class="opacity-50 mx-1">â€¢</span>
                                        <span class="font-mono opacity-75" x-text="'Turn ' + event.turn_index"></span>
                                    </div>
                                    <div class="p-4 rounded-2xl text-sm leading-relaxed shadow-sm border border-transparent"
                                         :class="{
                                             'bg-white text-primary rounded-tl-none border-gray-200': event.actor_role === 'player1',
                                             'bg-blue-600 text-white rounded-tr-none shadow-md': event.actor_role === 'player2'
                                         }">
                                        <div class="whitespace-pre-wrap" x-text="getEventText(event)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="visibleEvents.length === 0" class="text-center py-20 text-secondary">
                        <p>Press "Play" or "Next" to start the replay.</p>
                    </div>
                </div>
            </div>

            <!-- Inspector Panel (Right) -->
            <div class="w-96 bg-white border-l border-border flex flex-col shrink-0">
                <div class="px-4 py-3 border-b border-border bg-gray-50/50">
                    <h3 class="font-semibold text-sm text-secondary uppercase tracking-wider">State Inspector</h3>
                </div>
                <div class="flex-grow overflow-y-auto p-4 font-mono text-xs">
                    <template x-if="currentEvent">
                        <div class="space-y-4">
                            <div>
                                <span class="text-secondary block mb-1">Timestamp</span>
                                <span class="bg-gray-100 px-2 py-1 rounded" x-text="new Date(currentEvent.created_at).toISOString()"></span>
                            </div>
                            <div>
                                <span class="text-secondary block mb-1">Type</span>
                                <span class="badge badge-neutral" x-text="currentEvent.type"></span>
                            </div>
                            <div>
                                <span class="text-secondary block mb-1">Payload</span>
                                <pre class="bg-slate-900 text-slate-50 p-3 rounded-md overflow-x-auto text-[10px] leading-4" x-text="JSON.stringify(currentEvent.payload, null, 2)"></pre>
                            </div>
                        </div>
                    </template>
                    <template x-if="!currentEvent">
                        <div class="text-secondary italic text-center mt-10">No event selected</div>
                    </template>
                </div>
            </div>

        </div>
    </div>

    <script>
        function replayViewer(matchId) {
            return {
                matchId,
                events: [],
                currentIndex: -1,
                isPlaying: false,
                timer: null,

                async init() {
                    const res = await fetch(`/matches/${this.matchId}/events`);
                    this.events = await res.json();
                },

                get visibleEvents() {
                    return this.events.slice(0, this.currentIndex + 1);
                },

                get currentEvent() {
                    if (this.currentIndex < 0) return null;
                    return this.events[this.currentIndex];
                },

                getEventText(event) {
                    if (event.payload?.content) return event.payload.content;
                    if (event.payload?.message) return event.payload.message;
                    return JSON.stringify(event.payload);
                },

                next() {
                    if (this.currentIndex < this.events.length - 1) {
                        this.currentIndex++;
                        this.$nextTick(() => {
                            const el = document.getElementById('transcript');
                            el.scrollTop = el.scrollHeight;
                        });
                    } else {
                        this.pause();
                    }
                },

                prev() {
                    if (this.currentIndex > -1) {
                        this.currentIndex--;
                    }
                },

                reset() {
                    this.currentIndex = -1;
                    this.pause();
                },

                togglePlay() {
                    if (this.isPlaying) {
                        this.pause();
                    } else {
                        this.play();
                    }
                },

                play() {
                    this.isPlaying = true;
                    this.timer = setInterval(() => {
                        this.next();
                    }, 1500); // 1.5 second per step for better readability
                },

                pause() {
                    this.isPlaying = false;
                    clearInterval(this.timer);
                }
            }
        }
    </script>
<%- include('../partials/footer_layout') %>
