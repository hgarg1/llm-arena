<%- include('../partials/header_layout') %>
    <div x-data="replayViewer('<%= match.id %>')" x-init="init()" class="flex flex-col h-[calc(100vh-60px)]">
        
        <!-- Toolbar -->
        <div class="border-b border-border bg-white px-6 py-3 flex justify-between items-center shadow-sm z-10 shrink-0">
            <div class="flex items-center gap-4">
                <a href="/matches" class="text-secondary hover:text-primary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </a>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Match Replay</h1>
                    <div class="text-xs font-mono text-secondary"><%= match.id %></div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                <button @click="reset()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" title="Reset">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
                </button>
                <button @click="prev()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" :disabled="currentIndex <= 0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <button @click="togglePlay()" class="btn btn-sm btn-white bg-white text-primary shadow min-w-[80px] font-medium" x-text="isPlaying ? 'Pause' : 'Play'"></button>
                <button @click="next()" class="btn btn-sm btn-ghost hover:bg-white shadow-sm transition-all" :disabled="currentIndex >= events.length - 1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-grow flex overflow-hidden bg-gray-50">
            
            <% if (match.game_type === 'chess') { %>
            <!-- Chess Board (Left) -->
            <div class="flex-1 flex justify-center items-center p-4 lg:p-8 bg-slate-200 min-w-[400px]" id="board-container">
                 <div class="relative aspect-square w-full max-w-[600px] max-h-[80vh] bg-white shadow-2xl rounded-sm border-4 border-slate-800">
                     <!-- Rank Labels -->
                     <div class="absolute left-[-20px] top-0 bottom-0 flex flex-col justify-around text-xs font-bold text-slate-500">
                         <span>8</span><span>7</span><span>6</span><span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
                     </div>
                     <!-- File Labels -->
                     <div class="absolute bottom-[-20px] left-0 right-0 flex justify-around text-xs font-bold text-slate-500">
                         <span>a</span><span>b</span><span>c</span><span>d</span><span>e</span><span>f</span><span>g</span><span>h</span>
                     </div>

                     <!-- Board Grid -->
                     <div class="grid grid-cols-8 grid-rows-8 w-full h-full">
                         <template x-for="(row, rIndex) in boardState" :key="rIndex">
                             <template x-for="(square, cIndex) in row" :key="cIndex">
                                 <div class="w-full h-full flex items-center justify-center select-none relative"
                                      :class="(rIndex + cIndex) % 2 === 0 ? 'bg-[#f0d9b5]' : 'bg-[#b58863]'">
                                     <span x-html="getPieceSymbol(square)" 
                                           class="absolute inset-0 flex items-center justify-center text-[min(8vw,4rem)] leading-none transition-transform duration-200"
                                           :class="square?.color === 'w' ? 'text-white drop-shadow-[0_1px_1px_rgba(0,0,0,0.8)]' : 'text-black drop-shadow-[0_1px_0_rgba(255,255,255,0.5)]'">
                                     </span>
                                 </div>
                             </template>
                         </template>
                     </div>
                 </div>
            </div>
            <% } else if (match.game_type === 'chutes_and_ladders') { %>
            <!-- Chutes & Ladders Board (Left) -->
            <div class="flex-1 flex justify-center items-center p-4 lg:p-8 bg-slate-100 min-w-[400px]" id="board-container">
                <div class="relative aspect-square w-full max-w-[600px] max-h-[80vh] bg-white shadow-xl border-2 border-slate-300 grid grid-cols-10 grid-rows-10">
                    <!-- SVG Overlay for Transitions -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none z-10" id="transitions-layer">
                        <defs>
                            <marker id="arrowhead-ladder" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#16A34A" />
                            </marker>
                            <marker id="arrowhead-chute" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#DC2626" />
                            </marker>
                        </defs>
                        <!-- Transitions will be drawn by JS or we can hardcode if known -->
                        <!-- Hardcoding standard layout based on Milton Bradley -->
                        <!-- Ladders -->
                        <line x1="5%" y1="95%" x2="25%" y2="65%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 1->38 -->
                        <line x1="35%" y1="95%" x2="65%" y2="85%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 4->14 -->
                        <line x1="85%" y1="95%" x2="95%" y2="65%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 9->31 -->
                        <line x1="5%" y1="75%" x2="15%" y2="55%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 21->42 -->
                        <line x1="75%" y1="75%" x2="35%" y2="15%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 28->84 (Long!) -->
                        <line x1="45%" y1="65%" x2="35%" y2="55%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 36->44 -->
                        <line x1="95%" y1="45%" x2="65%" y2="35%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 51->67 -->
                        <line x1="95%" y1="25%" x2="95%" y2="5%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 71->91 -->
                        <line x1="5%" y1="25%" x2="5%" y2="5%" stroke="#16A34A" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrowhead-ladder)" /> <!-- 80->100 -->

                        <!-- Chutes -->
                        <line x1="45%" y1="85%" x2="55%" y2="95%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 16->6 -->
                        <line x1="65%" y1="55%" x2="55%" y2="75%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 47->26 -->
                        <line x1="85%" y1="55%" x2="95%" y2="85%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 49->11 -->
                        <line x1="45%" y1="45%" x2="75%" y2="45%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 56->53 -->
                        <line x1="15%" y1="35%" x2="15%" y2="85%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 62->19 (Long drop) -->
                        <line x1="35%" y1="35%" x2="5%" y2="45%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 64->60 -->
                        <line x1="65%" y1="15%" x2="35%" y2="75%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 87->24 (Massive drop) -->
                        <line x1="75%" y1="5%" x2="75%" y2="25%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 93->73 -->
                        <line x1="55%" y1="5%" x2="55%" y2="25%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 95->75 -->
                        <line x1="25%" y1="5%" x2="25%" y2="25%" stroke="#DC2626" stroke-width="2" marker-end="url(#arrowhead-chute)" /> <!-- 98->78 -->
                    </svg>

                    <!-- Cells -->
                    <template x-for="i in 100" :key="i">
                        <div class="border border-slate-100 flex items-center justify-center relative text-xs text-slate-400"
                             :class="getBgColor(getGridIndex(i))"
                             :style="getGridStyle(i)">
                            <span x-text="i" class="absolute top-1 left-1 opacity-50"></span>
                            
                            <!-- Player Token -->
                            <template x-if="currentPosition === i">
                                <div class="w-6 h-6 rounded-full bg-blue-600 shadow-lg border-2 border-white z-20 animate-bounce"></div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            <% } else if (match.game_type === 'texas_holdem') { %>
            <!-- Poker Table (Left) -->
            <div class="flex-1 flex justify-center items-center p-4 lg:p-8 bg-slate-900 min-w-[400px]" id="board-container">
                <div class="relative w-full max-w-[900px] aspect-[16/9] bg-[#2d5a40] rounded-[150px] border-[16px] border-[#3e2723] shadow-2xl flex items-center justify-center overflow-visible">
                    <!-- Felt Texture -->
                    <div class="absolute inset-0 rounded-[135px] border-[2px] border-[#1a382b] bg-[radial-gradient(ellipse_at_center,_#35654d_0%,_#244635_100%)]"></div>
                    
                    <!-- Branding -->
                    <div class="absolute top-1/4 text-[#1a382b]/30 font-bold text-4xl tracking-widest pointer-events-none select-none">LLM ARENA</div>

                    <!-- Audit Toggle -->
                    <div class="absolute top-4 right-4 z-20">
                        <label class="flex items-center gap-2 cursor-pointer bg-black/40 px-3 py-1.5 rounded-full hover:bg-black/60 transition">
                            <input type="checkbox" x-model="auditMode" class="w-4 h-4 accent-yellow-500 rounded">
                            <span class="text-xs text-white font-medium uppercase tracking-wide">Audit Cards</span>
                        </label>
                    </div>

                    <!-- Community Cards -->
                    <div class="flex gap-3 p-6 bg-[#1a382b]/40 rounded-xl border border-[#4a7c62]/30 relative z-10 backdrop-blur-sm min-h-[120px] min-w-[300px] items-center justify-center">
                        <template x-for="(card, i) in communityCards" :key="i">
                            <div class="w-16 h-24 bg-white rounded-lg shadow-xl flex flex-col items-center justify-center border border-gray-200 ring-1 ring-black/5 transform transition-all duration-300 hover:-translate-y-1"
                                 :class="['h','d'].includes(card.slice(-1)) ? 'text-red-600' : 'text-slate-900'">
                                <div class="text-xl font-bold leading-none" x-text="getCardRank(card)"></div>
                                <div class="text-2xl leading-none mt-1" x-text="getCardSuit(card)"></div>
                            </div>
                        </template>
                        <template x-if="communityCards.length === 0">
                            <div class="text-green-100/40 text-sm font-mono uppercase tracking-widest">Waiting for Flop</div>
                        </template>
                    </div>

                    <!-- Pot -->
                    <div class="absolute bottom-[35%] text-center z-10">
                        <div class="inline-flex flex-col items-center bg-black/30 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/10">
                            <div class="text-[10px] text-green-300 uppercase tracking-widest font-bold mb-0.5">Pot Size</div>
                            <div class="text-2xl text-white font-mono font-bold tracking-tight text-shadow">
                                <span class="text-yellow-400 mr-1">$</span><span x-text="pot"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Player Seats (Dynamic Layout) -->
                    <template x-for="(player, index) in players" :key="index">
                        <div class="absolute flex flex-col items-center z-20 transition-all duration-500"
                             :style="getSeatStyle(index, players.length)">
                            
                            <!-- Cards -->
                            <div class="flex gap-1 mb-2 transition-all duration-300"
                                 :class="{'translate-y-2 opacity-50': player.folded}"
                                 x-show="player.holeCards.length > 0">
                                <template x-for="card in player.holeCards">
                                    <div class="w-10 h-14 md:w-12 md:h-16 rounded-md shadow-lg border border-gray-200 flex flex-col items-center justify-center relative bg-white"
                                         :class="['h','d'].includes(card.slice(-1)) ? 'text-red-600' : 'text-slate-900'">
                                        
                                        <!-- Front -->
                                        <div x-show="auditMode || isShowdown" class="flex flex-col items-center justify-center w-full h-full">
                                            <div class="text-sm md:text-lg font-bold leading-none" x-text="getCardRank(card)"></div>
                                            <div class="text-base md:text-xl leading-none" x-text="getCardSuit(card)"></div>
                                        </div>
                                        
                                        <!-- Back (Hidden) -->
                                        <div x-show="!auditMode && !isShowdown" class="absolute inset-0 bg-blue-800 rounded-md border-2 border-white/20" 
                                             style="background-image: repeating-linear-gradient(45deg, #1e40af 0, #1e40af 2px, #172554 0, #172554 4px);">
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Avatar -->
                            <div class="relative group">
                                <div class="w-14 h-14 md:w-16 md:h-16 rounded-full border-4 flex items-center justify-center shadow-xl relative bg-slate-100 transition-all duration-300"
                                     :class="activeSeat === (index + 1) ? 'border-yellow-400 ring-4 ring-yellow-400/30 scale-110 z-30' : 'border-slate-300 grayscale opacity-90'">
                                    <div class="text-center">
                                        <div class="text-[8px] uppercase font-bold text-slate-500 tracking-wider" x-text="'Seat ' + (index + 1)"></div>
                                        <div class="font-black text-slate-800 text-xs md:text-sm">AI</div>
                                    </div>
                                    <!-- Dealer Button -->
                                    <div x-show="dealerSeat === (index + 1)" class="absolute -top-2 -right-2 w-5 h-5 bg-white rounded-full border-2 border-slate-200 flex items-center justify-center text-[10px] font-black text-slate-900 shadow-md z-40">D</div>
                                </div>
                                
                                <!-- Bet Bubble -->
                                <div class="absolute top-1/2 -right-16 -translate-y-1/2 flex items-center gap-2 z-50" x-show="player.currentBet > 0">
                                    <div class="bg-black/60 text-yellow-400 px-2 py-0.5 rounded-full font-mono font-bold text-xs border border-yellow-400/30 shadow-lg backdrop-blur-md">
                                        +<span x-text="player.currentBet"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Stack -->
                            <div class="mt-2 bg-slate-900 text-white px-3 py-1 rounded-full text-xs font-mono font-medium border border-slate-700 shadow-lg">
                                $<span x-text="player.stack"></span>
                            </div>
                        </div>
                    </template>

                </div>
            </div>
            <% } else if (match.game_type === 'blackjack') { %>
            <!-- Blackjack Table (Left) -->
            <div class="flex-1 flex justify-center items-center p-4 lg:p-8 bg-slate-900 min-w-[400px]" id="board-container">
                <div class="relative w-full max-w-[900px] aspect-[16/9] bg-[#0f3828] rounded-[150px] border-[16px] border-[#3e2723] shadow-2xl flex flex-col items-center justify-between py-12 overflow-visible">
                    <!-- Felt Texture -->
                    <div class="absolute inset-0 rounded-[135px] border-[2px] border-[#0a261a] bg-[radial-gradient(ellipse_at_center,_#1a4533_0%,_#0a261a_100%)]"></div>
                    
                    <!-- Branding -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#1a4533]/40 font-black text-6xl tracking-widest pointer-events-none select-none rotate-12">BLACKJACK</div>

                    <!-- Dealer Area (Top) -->
                    <div class="relative z-10 flex flex-col items-center">
                        <div class="mb-2 text-xs font-bold text-green-200 uppercase tracking-widest">Dealer</div>
                        <div class="flex gap-2">
                            <template x-for="(card, i) in dealerHand" :key="i">
                                <div class="w-16 h-24 bg-white rounded-lg shadow-xl flex flex-col items-center justify-center border border-gray-200 ring-1 ring-black/5 relative transition-all duration-300"
                                     :class="['h','d'].includes(card.slice(-1)) ? 'text-red-600' : 'text-slate-900'">
                                    
                                    <!-- Hidden Card logic: if !dealerRevealed and i > 0, show back -->
                                    <template x-if="!dealerRevealed && i > 0 && !auditMode">
                                        <div class="absolute inset-0 bg-red-900 rounded-lg border-2 border-white/20" 
                                             style="background-image: repeating-linear-gradient(45deg, #7f1d1d 0, #7f1d1d 2px, #991b1b 0, #991b1b 4px);"></div>
                                    </template>
                                    
                                    <!-- Visible Card -->
                                    <div x-show="dealerRevealed || i === 0 || auditMode" class="flex flex-col items-center">
                                        <div class="text-xl font-bold leading-none" x-text="getCardRank(card)"></div>
                                        <div class="text-2xl leading-none mt-1" x-text="getCardSuit(card)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="mt-2 px-3 py-1 bg-black/40 rounded-full text-white font-mono text-sm" x-show="dealerRevealed || auditMode">
                            <span x-text="getHandValue(dealerHand)"></span>
                        </div>
                    </div>

                    <!-- Players Area (Bottom) -->
                    <div class="relative z-10 flex gap-8 justify-center items-end w-full px-12">
                        <template x-for="(player, index) in players" :key="index">
                            <div class="flex flex-col items-center transition-opacity duration-300" 
                                 :class="activeSeat === (index + 1) ? 'opacity-100 scale-105' : 'opacity-80'">
                                
                                <!-- Status Badge -->
                                <div class="mb-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shadow-sm"
                                          :class="{
                                              'bg-yellow-500 text-black': player.status === 'active' && activeSeat === (index + 1),
                                              'bg-green-500 text-white': player.status === 'stand',
                                              'bg-red-500 text-white': player.status === 'bust',
                                              'bg-slate-600 text-slate-300': player.status === 'active' && activeSeat !== (index + 1)
                                          }"
                                          x-text="player.status"></span>
                                </div>

                                <!-- Cards -->
                                <div class="flex -space-x-8 mb-3">
                                    <template x-for="card in player.hand">
                                        <div class="w-14 h-20 bg-white rounded-md shadow-lg border border-gray-200 flex flex-col items-center justify-center relative hover:-translate-y-4 transition-transform duration-200"
                                             :class="['h','d'].includes(card.slice(-1)) ? 'text-red-600' : 'text-slate-900'">
                                            <div class="text-lg font-bold leading-none" x-text="getCardRank(card)"></div>
                                            <div class="text-xl leading-none" x-text="getCardSuit(card)"></div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Info -->
                                <div class="bg-slate-900/90 text-white px-4 py-2 rounded-lg text-center border border-slate-700 shadow-lg min-w-[100px]">
                                    <div class="text-xs text-slate-400 uppercase font-bold mb-0.5" x-text="'Seat ' + (index + 1)"></div>
                                    <div class="font-mono text-lg font-bold flex justify-center items-center gap-2">
                                        <span x-text="getHandValue(player.hand)"></span>
                                        <span class="text-xs font-normal text-slate-500" x-text="'$' + player.stack"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                </div>
            </div>
            <% } %>

            <!-- Transcript (Center/Left) -->
            <div class="<%= match.game_type === 'chess' ? 'w-full md:w-96 border-l border-border shrink-0' : 'flex-1' %> overflow-y-auto p-4 md:p-6 flex flex-col items-center bg-gray-50/50" id="transcript">
                <div class="w-full max-w-3xl space-y-6 pb-12">
                    <template x-for="(event, index) in visibleEvents" :key="event.id">
                        <div class="animate-in fade-in slide-in-from-bottom-2 duration-300">
                            <!-- System Message -->
                            <div x-show="event.actor_role === 'system'" class="flex justify-center my-4">
                                <span class="bg-gray-200 text-gray-600 text-[10px] md:text-xs font-mono px-3 py-1 rounded-full uppercase tracking-wide text-center break-all" x-text="getEventText(event)"></span>
                            </div>

                            <!-- Player Message -->
                            <div x-show="event.actor_role !== 'system'" 
                                 class="flex gap-3 md:gap-4" 
                                 :class="{'flex-row-reverse': event.actor_role === 'player2' || event.actor_role === 'black'}">
                                
                                <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-xs font-bold shadow-sm ring-2 ring-white"
                                     :class="{
                                         'bg-blue-100 text-blue-700': event.actor_role === 'player1' || event.actor_role === 'white', 
                                         'bg-emerald-100 text-emerald-700': event.actor_role === 'player2' || event.actor_role === 'black'
                                     }">
                                     <span x-text="(event.actor_role === 'player1' || event.actor_role === 'white') ? 'W' : 'B'"></span>
                                </div>

                                <div class="max-w-[85%] min-w-0">
                                    <div class="text-[10px] md:text-xs text-secondary mb-1 px-1 flex items-center gap-1" 
                                         :class="{'flex-row-reverse': event.actor_role === 'player2' || event.actor_role === 'black'}">
                                        <span class="font-medium uppercase truncate" x-text="event.actor_role"></span>
                                        <span class="opacity-50">•</span>
                                        <span class="font-mono opacity-75 whitespace-nowrap" x-text="'T' + event.turn_index"></span>
                                    </div>
                                    <div class="p-3 md:p-4 rounded-2xl text-sm leading-relaxed shadow-sm border border-transparent overflow-hidden"
                                         :class="{
                                             'bg-white text-primary rounded-tl-none border-gray-200': event.actor_role === 'player1' || event.actor_role === 'white',
                                             'bg-blue-600 text-white rounded-tr-none shadow-md': event.actor_role === 'player2' || event.actor_role === 'black'
                                         }">
                                        <div class="font-mono break-words whitespace-pre-wrap" x-text="getEventText(event)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="visibleEvents.length === 0" class="text-center py-20 text-secondary">
                        <p>Press "Play" or "Next" to start the replay.</p>
                    </div>
                </div>
            </div>

            <!-- Inspector Panel (Right) -->
            <div class="hidden xl:flex w-80 bg-white border-l border-border flex-col shrink-0">
                <div class="px-4 py-3 border-b border-border bg-gray-50/50">
                    <h3 class="font-semibold text-sm text-secondary uppercase tracking-wider">State Inspector</h3>
                </div>
                <div class="flex-grow overflow-y-auto p-4 font-mono text-xs">
                    <template x-if="currentEvent">
                        <div class="space-y-4">
                            <div>
                                <span class="text-secondary block mb-1">Timestamp</span>
                                <span class="bg-gray-100 px-2 py-1 rounded inline-block" x-text="new Date(currentEvent.created_at).toISOString()"></span>
                            </div>
                            <div>
                                <span class="text-secondary block mb-1">Type</span>
                                <span class="badge badge-neutral" x-text="currentEvent.type"></span>
                            </div>
                            <div>
                                <span class="text-secondary block mb-1">Payload</span>
                                <pre class="bg-slate-900 text-slate-50 p-3 rounded-md overflow-x-auto text-[10px] leading-4 scrollbar-thin scrollbar-thumb-slate-700" x-text="JSON.stringify(currentEvent.payload, null, 2)"></pre>
                            </div>
                        </div>
                    </template>
                    <template x-if="!currentEvent">
                        <div class="text-secondary italic text-center mt-10">No event selected</div>
                    </template>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script>
        function replayViewer(matchId) {
            return {
                matchId,
                events: [],
                currentIndex: -1,
                isPlaying: false,
                timer: null,
                chess: new Chess(),
                boardState: [],
                currentPosition: 0, // For Chutes and Ladders

                // Poker State
                players: [{stack: 1000, currentBet: 0, folded: false, holeCards: []}, {stack: 1000, currentBet: 0, folded: false, holeCards: []}],
                communityCards: [],
                pot: 0,
                activeSeat: 0,
                dealerSeat: 1,
                auditMode: false,
                isShowdown: false,
                
                // Blackjack State
                dealerHand: [],
                dealerRevealed: false,

                async init() {
                    const res = await fetch(`/matches/${this.matchId}/events`);
                    this.events = await res.json();
                    this.updateBoard();
                },

                getHandValue(cards) {
                    let value = 0;
                    let aces = 0;
                    for (const card of cards) {
                        const rank = this.getCardRank(card);
                        if (['10', 'J', 'Q', 'K'].includes(rank)) value += 10;
                        else if (rank === 'A') { value += 11; aces++; }
                        else value += parseInt(rank);
                    }
                    while (value > 21 && aces > 0) {
                        value -= 10;
                        aces--;
                    }
                    return value;
                },

                get visibleEvents() {
                    return this.events.slice(0, this.currentIndex + 1);
                },

                get currentEvent() {
                    if (this.currentIndex < 0) return null;
                    return this.events[this.currentIndex];
                },

                getPieceSymbol(piece) {
                    if (!piece) return '';
                    const symbols = {
                        'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚'
                    };
                    return symbols[piece.type] || '';
                },

                getCardRank(card) {
                    if (!card) return '';
                    const ranks = {
                        'T': '10', 'J': 'J', 'Q': 'Q', 'K': 'K', 'A': 'A'
                    };
                    return ranks[card.slice(0, -1)] || card.slice(0, -1);
                },

                getCardSuit(card) {
                    if (!card) return '';
                    const suits = {
                        'h': '♥', 'd': '♦', 'c': '♣', 's': '♠'
                    };
                    return suits[card.slice(-1)] || '';
                },

                getCardSymbol(card) {
                    return this.getCardRank(card) + this.getCardSuit(card);
                },

                getSeatStyle(index, total) {
                    // Position players in an ellipse around the table
                    // Table size approx 800x450 (aspect 16/9)
                    // Center is 50% 50%
                    // We distribute angles from 0 to 360 starting from bottom (90 deg)
                    
                    if (total === 2) {
                        if (index === 0) return 'bottom: -40px; left: 50%; transform: translateX(-50%);';
                        if (index === 1) return 'top: -40px; left: 50%; transform: translateX(-50%);';
                    }

                    // For N > 2, distribute around ellipse
                    // a = 45%, b = 45% (circularish within rectangular container relative coords)
                    // Start angle = 90 (bottom)
                    const angleStep = 360 / total;
                    const startAngle = 90;
                    const angle = (startAngle + index * angleStep) * (Math.PI / 180);
                    
                    // Radius
                    const rx = 42; // % width
                    const ry = 42; // % height
                    
                    const x = 50 + rx * Math.cos(angle);
                    const y = 50 + ry * Math.sin(angle);
                    
                    return `left: ${x}%; top: ${y}%; transform: translate(-50%, -50%);`;
                },

                // Helper to map 1-100 to CSS Grid order (Boustrophedon / Zig-Zag)
                getGridStyle(i) {
                    const rowFromBottom = Math.floor((i - 1) / 10);
                    const cssRow = 10 - rowFromBottom;
                    let cssCol;
                    if (rowFromBottom % 2 === 0) {
                        cssCol = (i - 1) % 10 + 1;
                    } else {
                        cssCol = 10 - ((i - 1) % 10);
                    }
                    return `grid-area: ${cssRow} / ${cssCol} / span 1 / span 1;`;
                },
                
                getGridIndex(i) {
                    return i;
                },

                getBgColor(i) {
                    return (Math.floor((i-1)/10) % 2 === (i-1)%2) ? 'bg-white' : 'bg-slate-50';
                },

                updateBoard() {
                    const evt = this.currentEvent;
                    
                    // Reset Logic for all games
                    if (!evt || this.currentIndex === -1) {
                        this.chess.reset();
                        this.currentPosition = 0;
                        this.players = [{stack: 1000, currentBet: 0, folded: false, holeCards: []}, {stack: 1000, currentBet: 0, folded: false, holeCards: []}];
                        this.communityCards = [];
                        this.pot = 0;
                        this.activeSeat = 0;
                        this.boardState = this.chess.board(); // Ensure boardState is valid initially
                        return;
                    }

                    // Chess Update
                    if (evt.type === 'MATCH_START' && evt.payload && evt.payload.game_key === 'chess') {
                         if (evt.payload.start_fen) this.chess.load(evt.payload.start_fen);
                         else this.chess.reset();
                    } else if (evt.payload && evt.payload.fen_after) {
                         this.chess.load(evt.payload.fen_after);
                    } else if (evt.type === 'MOVE' && evt.payload && evt.payload.uci) {
                         // Optional fallback if fen not present (should be there)
                    }
                    this.boardState = this.chess.board();
                    
                    // Chutes Update
                    if (evt.payload && evt.payload.position_after !== undefined) {
                        this.currentPosition = evt.payload.position_after;
                    } else if (evt.payload && evt.payload.final_position !== undefined) {
                        this.currentPosition = evt.payload.final_position;
                    }

                    // Blackjack Update
                    if (this.matchId && evt.payload && (evt.payload.game_key === 'blackjack' || (this.events[0].payload && this.events[0].payload.game_key === 'blackjack'))) {
                        let bjPlayers = [];
                        let bjDealerHand = [];
                        let bjDealerRevealed = false;
                        let active = 1;

                        for (let i = 0; i <= this.currentIndex; i++) {
                            const e = this.events[i];
                            const p = e.payload;
                            if (!e || !p) continue;

                            if (e.type === 'MATCH_START') {
                                const count = p.player_count || 1;
                                bjPlayers = [];
                                for(let j=0; j<count; j++) {
                                    bjPlayers.push({id: `seat${j+1}`, hand: [], stack: 1000 - (p.fixed_bet || 10), status: 'active', bet: p.fixed_bet || 10});
                                }
                            } else if (e.type === 'DEAL_CARD') {
                                if (bjPlayers[p.seat - 1]) bjPlayers[p.seat - 1].hand.push(p.card);
                            } else if (e.type === 'DEAL_DEALER') {
                                bjDealerHand.push(...p.cards);
                            } else if (e.type === 'PLAYER_ACTION') {
                                active = p.seat;
                                if (p.action === 'stand') {
                                    if (bjPlayers[p.seat - 1]) bjPlayers[p.seat - 1].status = 'stand';
                                }
                            } else if (e.type === 'PLAYER_TURN_END') {
                                if (bjPlayers[p.seat - 1]) bjPlayers[p.seat - 1].status = p.result;
                                active = p.seat + 1;
                            } else if (e.type === 'DEALER_REVEAL') {
                                bjDealerRevealed = true;
                                active = 0; // Dealer turn
                            } else if (e.type === 'DEALER_ACTION') {
                                if (p.action === 'hit' && p.card) bjDealerHand.push(p.card);
                            } else if (e.type === 'HAND_RESULT') {
                                if (bjPlayers[p.seat - 1]) bjPlayers[p.seat - 1].stack = p.stack_after;
                            }
                        }
                        
                        this.players = bjPlayers;
                        this.dealerHand = bjDealerHand;
                        this.dealerRevealed = bjDealerRevealed;
                        this.activeSeat = active > bjPlayers.length ? 0 : active;
                        return; // Exit
                    }

                    // Reset Poker State
                    let players = [];
                    // Initialize empty players if we know count? 
                    // Better to re-initialize on MATCH_START
                    
                    let commCards = [];
                    let currentPot = 0;
                    let active = 0;
                    let dealer = 1;
                    let showdown = false;

                    for (let i = 0; i <= this.currentIndex; i++) {
                        const e = this.events[i];
                        const p = e.payload;
                        if (!e || !p) continue;
                        
                        if (e.type === 'MATCH_START') {
                            const count = p.player_count || 2;
                            players = [];
                            for(let j=0; j<count; j++) {
                                players.push({stack: p.starting_stack || 1000, currentBet: 0, folded: false, holeCards: []});
                            }
                        } else if (e.type === 'DEAL_HOLE_CARDS') {
                            if (players[p.seat - 1]) players[p.seat - 1].holeCards = p.cards;
                        } else if (e.type === 'POST_BLINDS') {
                            if (players[p.sb_seat - 1]) {
                                players[p.sb_seat - 1].stack -= p.amounts[0];
                                players[p.sb_seat - 1].currentBet = p.amounts[0];
                            }
                            if (players[p.bb_seat - 1]) {
                                players[p.bb_seat - 1].stack -= p.amounts[1];
                                players[p.bb_seat - 1].currentBet = p.amounts[1];
                            }
                            currentPot += (p.amounts[0] + p.amounts[1]);
                        } else if (e.type === 'DEAL_COMMUNITY') {
                            commCards.push(...p.cards);
                            players.forEach(pl => pl.currentBet = 0); // Reset bets for new round
                        } else if (e.type === 'PLAYER_ACTION') {
                            const seat = p.seat;
                            const pl = players[seat - 1];
                            if (pl) {
                                if (p.action === 'fold') pl.folded = true;
                                if (p.stack_after !== undefined) {
                                    const diff = pl.stack - p.stack_after;
                                    currentPot += diff;
                                    pl.stack = p.stack_after;
                                    if (p.action !== 'fold') pl.currentBet += diff;
                                }
                                active = (seat % players.length) + 1; // Naive turn pass
                            }
                        } else if (e.type === 'POT_AWARDED') {
                            if (p.seat === 'split') {
                                // Simple visual split not handled precisely here for N players in MVP
                            } else if (players[p.seat - 1]) {
                                players[p.seat - 1].stack += p.amount;
                            }
                            currentPot = 0;
                        } else if (e.type === 'SHOWDOWN') {
                            showdown = true;
                        }
                    }

                    // Fallback if players empty (e.g. no match_start event yet or old data)
                    if (players.length === 0) {
                         players = [{stack: 1000, currentBet: 0, folded: false, holeCards: []}, {stack: 1000, currentBet: 0, folded: false, holeCards: []}];
                    }

                    this.players = players;
                    this.communityCards = commCards;
                    this.pot = currentPot;
                    this.activeSeat = active;
                    this.isShowdown = showdown;
                },

                getEventText(event) {
                    if (event.payload?.san) return event.payload.san;
                    if (event.payload?.content) return event.payload.content;
                    if (event.payload?.message) return event.payload.message;
                    if (event.type === 'RESULT') return `Game Over: ${event.payload.outcome || ''} (${event.payload.reason || ''})`;
                    return JSON.stringify(event.payload);
                },

                next() {
                    if (this.currentIndex < this.events.length - 1) {
                        this.currentIndex++;
                        this.updateBoard(); 
                        this.$nextTick(() => {
                            const el = document.getElementById('transcript');
                            if(el) el.scrollTop = el.scrollHeight;
                        });
                    } else {
                        this.pause();
                    }
                },

                prev() {
                    if (this.currentIndex > -1) {
                        this.currentIndex--;
                        this.updateBoard();
                    }
                },

                reset() {
                    this.currentIndex = -1;
                    this.updateBoard();
                    this.pause();
                },

                togglePlay() {
                    if (this.isPlaying) {
                        this.pause();
                    } else {
                        this.play();
                    }
                },

                play() {
                    this.isPlaying = true;
                    this.timer = setInterval(() => {
                        this.next();
                    }, 1000); 
                },

                pause() {
                    this.isPlaying = false;
                    clearInterval(this.timer);
                }
            }
        }
    </script>
<%- include('../partials/footer_layout') %>
