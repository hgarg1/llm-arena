<%- include('../../partials/admin_header') %>
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">System Settings</h1>
        <p class="mt-1 text-sm text-gray-500">Global configuration and policy controls.</p>
    </div>

    <% if (success) { %>
        <div class="mb-6 rounded-md bg-green-50 p-4 border border-green-200 text-green-700 text-sm"><%= success %></div>
    <% } %>
    <% if (error) { %>
        <div class="mb-6 rounded-md bg-red-50 p-4 border border-red-200 text-red-700 text-sm"><%= error %></div>
    <% } %>

    <form action="/admin/settings" method="POST" class="space-y-8">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <!-- Global Announcements + Maintenance -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Global Banner & Maintenance</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Global Alert Banner</label>
                    <input type="text" name="global_alert" value="<%= settings['global_alert'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to disable. Appears on public pages.</p>
                </div>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="maintenance_mode" class="rounded border-gray-300" <%= settings['maintenance_mode'] === 'true' ? 'checked' : '' %>>
                    Enable maintenance mode (503 for public pages)
                </label>
            </div>
        </section>

        <!-- Auth Policy -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Authentication Policy</h3>
            </div>
            <div class="p-6 grid md:grid-cols-2 gap-6">
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="auth_require_email_verification" class="rounded border-gray-300" <%= settings['auth_require_email_verification'] !== 'false' ? 'checked' : '' %>>
                    Require email verification to sign in
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="auth_passkey_enabled" class="rounded border-gray-300" <%= settings['auth_passkey_enabled'] !== 'false' ? 'checked' : '' %>>
                    Enable passkey login
                </label>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Login attempts (per window)</label>
                    <input type="number" min="1" name="auth_login_attempts" value="<%= settings['auth_login_attempts'] || '10' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Login window (minutes)</label>
                    <input type="number" min="1" name="auth_login_window_minutes" value="<%= settings['auth_login_window_minutes'] || '15' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Password min length</label>
                    <input type="number" min="8" name="auth_password_min_length" value="<%= settings['auth_password_min_length'] || '12' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Password requirements</label>
                    <label class="inline-flex items-center gap-2 text-xs text-gray-600 mr-4">
                        <input type="checkbox" name="auth_password_require_upper" class="rounded border-gray-300" <%= settings['auth_password_require_upper'] !== 'false' ? 'checked' : '' %>>
                        Uppercase
                    </label>
                    <label class="inline-flex items-center gap-2 text-xs text-gray-600 mr-4">
                        <input type="checkbox" name="auth_password_require_lower" class="rounded border-gray-300" <%= settings['auth_password_require_lower'] !== 'false' ? 'checked' : '' %>>
                        Lowercase
                    </label>
                    <label class="inline-flex items-center gap-2 text-xs text-gray-600 mr-4">
                        <input type="checkbox" name="auth_password_require_number" class="rounded border-gray-300" <%= settings['auth_password_require_number'] !== 'false' ? 'checked' : '' %>>
                        Number
                    </label>
                    <label class="inline-flex items-center gap-2 text-xs text-gray-600">
                        <input type="checkbox" name="auth_password_require_special" class="rounded border-gray-300" <%= settings['auth_password_require_special'] !== 'false' ? 'checked' : '' %>>
                        Special
                    </label>
                </div>
            </div>
        </section>

        <!-- Session -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-bold text-gray-900">Session & Logout Controls</h3>
                <button class="btn btn-sm btn-secondary" form="force-logout-form">Force Logout All Users</button>
            </div>
            <div class="p-6 grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Idle timeout (minutes)</label>
                    <input type="number" min="5" name="session_idle_minutes" value="<%= settings['session_idle_minutes'] || '60' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Remember me duration (days)</label>
                    <input type="number" min="1" name="session_remember_days" value="<%= settings['session_remember_days'] || '7' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
            </div>
        </section>

        <!-- Limits -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Rate Limits & Quotas</h3>
            </div>
            <div class="p-6 grid md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Matches/day (FREE)</label>
                    <input type="number" min="0" name="limit_matches_per_day_free" value="<%= settings['limit_matches_per_day_free'] || '10' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                    <p class="text-[10px] text-gray-500 mt-1">0 = unlimited</p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Matches/day (PRO)</label>
                    <input type="number" min="0" name="limit_matches_per_day_pro" value="<%= settings['limit_matches_per_day_pro'] || '100' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Matches/day (ENTERPRISE)</label>
                    <input type="number" min="0" name="limit_matches_per_day_enterprise" value="<%= settings['limit_matches_per_day_enterprise'] || '0' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">API keys max (FREE)</label>
                    <input type="number" min="0" name="limit_api_keys_free" value="<%= settings['limit_api_keys_free'] || '3' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">API keys max (PRO)</label>
                    <input type="number" min="0" name="limit_api_keys_pro" value="<%= settings['limit_api_keys_pro'] || '10' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">API keys max (ENTERPRISE)</label>
                    <input type="number" min="0" name="limit_api_keys_enterprise" value="<%= settings['limit_api_keys_enterprise'] || '0' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Models max/user (FREE)</label>
                    <input type="number" min="0" name="limit_models_per_user_free" value="<%= settings['limit_models_per_user_free'] || '3' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Models max/user (PRO)</label>
                    <input type="number" min="0" name="limit_models_per_user_pro" value="<%= settings['limit_models_per_user_pro'] || '10' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Models max/user (ENTERPRISE)</label>
                    <input type="number" min="0" name="limit_models_per_user_enterprise" value="<%= settings['limit_models_per_user_enterprise'] || '0' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
            </div>
        </section>

        <!-- Queue Controls -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Queue Controls</h3>
            </div>
            <div class="p-6 grid md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Retry attempts</label>
                    <input type="number" min="1" name="queue_retry_attempts" value="<%= settings['queue_retry_attempts'] || '3' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Retry backoff (ms)</label>
                    <input type="number" min="0" name="queue_retry_backoff_ms" value="<%= settings['queue_retry_backoff_ms'] || '5000' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Worker concurrency</label>
                    <input type="number" min="1" name="queue_concurrency" value="<%= settings['queue_concurrency'] || '2' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Max turns per match</label>
                    <input type="number" min="1" name="queue_max_turns" value="<%= settings['queue_max_turns'] || '250' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                        <input type="checkbox" name="queue_auto_clean_enabled" class="rounded border-gray-300" <%= settings['queue_auto_clean_enabled'] === 'true' ? 'checked' : '' %>>
                        Enable auto-clean
                    </label>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Auto-clean interval (minutes)</label>
                        <input type="number" min="1" name="queue_auto_clean_interval_minutes" value="<%= settings['queue_auto_clean_interval_minutes'] || '60' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                    </div>
                </div>
            </div>
        </section>

        <!-- Security Headers -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Security Headers</h3>
            </div>
            <div class="p-6 grid md:grid-cols-2 gap-6">
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="security_hsts_enabled" class="rounded border-gray-300" <%= settings['security_hsts_enabled'] !== 'false' ? 'checked' : '' %>>
                    Enable HSTS
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="security_csp_allow_unsafe_eval" class="rounded border-gray-300" <%= settings['security_csp_allow_unsafe_eval'] === 'true' ? 'checked' : '' %>>
                    Allow unsafe-eval (needed for Alpine CDN build)
                </label>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">HSTS max-age (seconds)</label>
                    <input type="number" min="0" name="security_hsts_max_age" value="<%= settings['security_hsts_max_age'] || '15552000' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">CSP script-src extras (comma separated)</label>
                    <input type="text" name="security_csp_script_src" value="<%= settings['security_csp_script_src'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">CSP style-src extras</label>
                    <input type="text" name="security_csp_style_src" value="<%= settings['security_csp_style_src'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">CSP img-src extras</label>
                    <input type="text" name="security_csp_img_src" value="<%= settings['security_csp_img_src'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">CSP connect-src extras</label>
                    <input type="text" name="security_csp_connect_src" value="<%= settings['security_csp_connect_src'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">CSP font-src extras</label>
                    <input type="text" name="security_csp_font_src" value="<%= settings['security_csp_font_src'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Upload max size (MB)</label>
                    <input type="number" min="1" name="upload_max_mb" value="<%= settings['upload_max_mb'] || '5' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
            </div>
        </section>

        <!-- Default Tier -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Default User Tier</h3>
            </div>
            <div class="p-6">
                <select name="default_user_tier" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded">
                    <option value="FREE" <%= settings['default_user_tier'] === 'FREE' ? 'selected' : '' %>>FREE</option>
                    <option value="PRO" <%= settings['default_user_tier'] === 'PRO' ? 'selected' : '' %>>PRO</option>
                    <option value="ENTERPRISE" <%= settings['default_user_tier'] === 'ENTERPRISE' ? 'selected' : '' %>>ENTERPRISE</option>
                </select>
            </div>
        </section>

        <!-- Content Overrides -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Content Overrides</h3>
            </div>
            <div class="p-6 grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Public Home: Hero Title</label>
                    <input type="text" name="public:home:hero_title" value="<%= content['public:home:hero_title'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Public Home: Hero Subtitle</label>
                    <input type="text" name="public:home:hero_subtitle" value="<%= content['public:home:hero_subtitle'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Investor Home: Hero Title</label>
                    <input type="text" name="investor:home:hero_title" value="<%= content['investor:home:hero_title'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Investor Home: Hero Text</label>
                    <input type="text" name="investor:home:hero_text" value="<%= content['investor:home:hero_text'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Investor Press: Highlight Date</label>
                    <input type="text" name="investor:press:highlight_1_date" value="<%= content['investor:press:highlight_1_date'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Investor Press: Highlight Title</label>
                    <input type="text" name="investor:press:highlight_1_title" value="<%= content['investor:press:highlight_1_title'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
            </div>
        </section>

        <!-- Communications -->
        <section class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-900">Email & SMS</h3>
            </div>
            <div class="p-6 grid md:grid-cols-2 gap-6">
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="comms_email_enabled" class="rounded border-gray-300" <%= settings['comms_email_enabled'] !== 'false' ? 'checked' : '' %>>
                    Enable email sending
                </label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                    <input type="checkbox" name="comms_sms_enabled" class="rounded border-gray-300" <%= settings['comms_sms_enabled'] !== 'false' ? 'checked' : '' %>>
                    Enable SMS sending
                </label>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">SMS provider</label>
                    <select name="comms_sms_provider" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <option value="auto" <%= settings['comms_sms_provider'] === 'auto' ? 'selected' : '' %>>Auto</option>
                        <option value="twilio" <%= settings['comms_sms_provider'] === 'twilio' ? 'selected' : '' %>>Twilio</option>
                        <option value="mock" <%= settings['comms_sms_provider'] === 'mock' ? 'selected' : '' %>>Mock</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Test email address</label>
                    <input type="email" name="comms_email_test_address" value="<%= settings['comms_email_test_address'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Test SMS number</label>
                    <input type="text" name="comms_sms_test_number" value="<%= settings['comms_sms_test_number'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>
            </div>
        </section>

        <% if (typeof can === 'function' && can('admin.settings.edit')) { %>
        <div class="text-right">
            <button class="btn btn-primary">Save Settings</button>
        </div>
        <% } %>
    </form>

    <form id="force-logout-form" action="/admin/settings/force-logout" method="POST" class="hidden">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    </form>

    <!-- Test communications -->
    <% if (typeof can === 'function' && can('admin.comms.test')) { %>
    <div class="mt-8 grid md:grid-cols-2 gap-6">
        <form action="/admin/settings/test-email" method="POST" class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <h3 class="font-bold text-gray-900 mb-2">Send Test Email</h3>
            <input type="email" name="to" value="<%= settings['comms_email_test_address'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded mb-3" placeholder="you@company.com" required>
            <button class="btn btn-secondary">Send</button>
        </form>
        <form action="/admin/settings/test-sms" method="POST" class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <h3 class="font-bold text-gray-900 mb-2">Send Test SMS</h3>
            <input type="text" name="to" value="<%= settings['comms_sms_test_number'] || '' %>" class="w-full px-3 py-2 border border-gray-300 rounded mb-3" placeholder="+15551234567" required>
            <button class="btn btn-secondary">Send</button>
        </form>
    </div>
    <% } %>

    <!-- Audit Log -->
    <% if (typeof can === 'function' && can('admin.audit.view')) { %>
    <section class="mt-8 bg-white rounded-lg shadow border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="font-bold text-gray-900">Admin Audit Log</h3>
            <% if (typeof can === 'function' && can('admin.settings.audit_export')) { %>
                <a href="/admin/settings/audit/export" class="btn btn-sm btn-secondary">Export Excel</a>
            <% } %>
        </div>
        <div class="p-6">
            <% if (auditLogs && auditLogs.length > 0) { %>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left">
                        <thead class="text-xs uppercase text-gray-500 border-b">
                            <tr>
                                <th class="py-2 pr-4">Time</th>
                                <th class="py-2 pr-4">Admin</th>
                                <th class="py-2 pr-4">Action</th>
                                <th class="py-2 pr-4">Target</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <% auditLogs.forEach(log => { %>
                                <tr>
                                    <td class="py-2 pr-4 text-xs text-gray-500"><%= new Date(log.created_at).toLocaleString() %></td>
                                    <td class="py-2 pr-4"><%= log.admin?.email || 'Unknown' %></td>
                                    <td class="py-2 pr-4 font-mono text-xs"><%= log.action %></td>
                                    <td class="py-2 pr-4 text-xs text-gray-500"><%= log.target || '-' %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <p class="text-sm text-gray-500">No audit entries yet.</p>
            <% } %>
        </div>
    </section>
    <% } %>
<%- include('../../partials/admin_footer') %>
