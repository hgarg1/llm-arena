<%- include('../../../partials/admin_header') %>
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900"><%= application.full_name %></h1>
            <p class="text-sm text-gray-500"><%= application.job.title %> - <%= application.email %></p>
        </div>
        <a href="/admin/hr/applications" class="btn btn-sm btn-secondary">Back to list</a>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="text-sm font-semibold text-gray-900">Application Answers</div>
                <div class="mt-4 space-y-4 text-sm text-gray-700">
                    <% application.answers.forEach(answer => { %>
                        <div>
                            <div class="text-xs font-medium text-gray-500"><%= answer.question_label %></div>
                            <div class="mt-1"><%= answer.response || 'N/A' %></div>
                        </div>
                    <% }) %>
                </div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="text-sm font-semibold text-gray-900">Resume</div>
                <div class="mt-3 flex items-center gap-3 text-sm">
                    <% if (application.resume_path) { %>
                        <a href="<%= application.resume_path %>" class="text-blue-600 hover:underline" target="_blank">Download (local)</a>
                    <% } %>
                    <% if (application.resume_blob_url) { %>
                        <a href="<%= application.resume_blob_url %>" class="text-blue-600 hover:underline" target="_blank">Blob copy</a>
                    <% } %>
                </div>
                <div class="mt-4 text-xs text-gray-500 whitespace-pre-line"><%= (application.resume_text || '').slice(0, 1200) %></div>
            </div>
        </div>
        <div class="space-y-6">
            <div class="bg-slate-900 text-white rounded-xl p-6">
                <div class="text-xs uppercase tracking-widest text-slate-400">AI Signals</div>
                <div class="mt-4 text-sm">
                    <div>Fit Score: <span class="font-semibold"><%= application.ai_fit_score !== null ? application.ai_fit_score : 'N/A' %></span></div>
                    <div class="mt-2">Sentiment Score: <span class="font-semibold"><%= application.ai_sentiment_score !== null ? application.ai_sentiment_score : 'N/A' %></span></div>
                    <div class="mt-2">Review Score: <span class="font-semibold"><%= application.review_score !== null ? application.review_score : 'N/A' %></span></div>
                </div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="text-sm font-semibold text-gray-900">AI Summary</div>
                <div class="mt-3 text-xs text-gray-600">
                    <div class="font-medium">Application Sentiment</div>
                    <div class="mt-1"><%= application.ai_sentiment_application?.summary || 'N/A' %></div>
                    <% if (Array.isArray(application.ai_sentiment_application?.strengths)) { %>
                        <div class="mt-3 text-[11px] text-gray-500">Strengths: <%= application.ai_sentiment_application.strengths.join(', ') %></div>
                    <% } %>
                    <div class="mt-4 font-medium">Role Fit</div>
                    <div class="mt-1"><%= application.ai_sentiment_fit?.summary || 'N/A' %></div>
                    <% if (Array.isArray(application.ai_sentiment_fit?.signals)) { %>
                        <div class="mt-3 text-[11px] text-gray-500">Signals: <%= application.ai_sentiment_fit.signals.join(', ') %></div>
                    <% } %>
                    <% if (Array.isArray(application.ai_sentiment_fit?.gaps)) { %>
                        <div class="mt-2 text-[11px] text-amber-600">Gaps: <%= application.ai_sentiment_fit.gaps.join(', ') %></div>
                    <% } %>
                </div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="text-sm font-semibold text-gray-900">Review Status</div>
                <form action="/admin/hr/applications/<%= application.id %>/status" method="POST" class="space-y-3">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <label class="text-xs font-medium text-gray-600">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                        <option value="NEW" <%= application.status === 'NEW' ? 'selected' : '' %>>New</option>
                        <option value="IN_REVIEW" <%= application.status === 'IN_REVIEW' ? 'selected' : '' %>>In Review</option>
                        <option value="INTERVIEW" <%= application.status === 'INTERVIEW' ? 'selected' : '' %>>Interview</option>
                        <option value="OFFER" <%= application.status === 'OFFER' ? 'selected' : '' %>>Offer</option>
                        <option value="HIRED" <%= application.status === 'HIRED' ? 'selected' : '' %>>Hired</option>
                        <option value="REJECTED" <%= application.status === 'REJECTED' ? 'selected' : '' %>>Rejected</option>
                    </select>
                    <label class="text-xs font-medium text-gray-600">Admin Notes</label>
                    <textarea name="admin_notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"><%= application.admin_notes || '' %></textarea>
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 text-xs text-gray-600 space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="notify_email"> Notify candidate by email
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="notify_sms"> Notify candidate by SMS
                        </label>
                        <textarea name="message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded text-xs" placeholder="Optional note to include"></textarea>
                    </div>
                    <button class="btn btn-sm btn-primary">Save Status</button>
                </form>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-6">
                <div class="text-sm font-semibold text-gray-900">Interview Scheduling</div>
                <form action="/admin/hr/applications/<%= application.id %>/schedule" method="POST" class="mt-3 space-y-3">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <label class="text-xs font-medium text-gray-600">Scheduled At</label>
                    <input type="datetime-local" name="scheduled_at" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" value="<%= application.interview_scheduled_at ? new Date(application.interview_scheduled_at).toISOString().slice(0,16) : '' %>">
                    <label class="text-xs font-medium text-gray-600">Location / Link</label>
                    <input type="text" name="location" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" value="<%= application.interview_location || '' %>">
                    <label class="text-xs font-medium text-gray-600">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"><%= application.interview_notes || '' %></textarea>
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-3 text-xs text-gray-600 space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="notify_email" checked> Send calendar invite by email
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" name="notify_sms"> Send SMS reminder
                        </label>
                    </div>
                    <button class="btn btn-sm btn-primary">Schedule Interview</button>
                </form>
            </div>
        </div>
    </div>

    <div class="mt-8 bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-sm font-semibold text-gray-900">Rubric Scoring</div>
                <div class="text-xs text-gray-500">Score each category 0-5. Weighted score updates on save.</div>
            </div>
            <div class="text-xs text-gray-500">Current: <span class="font-semibold text-gray-900"><%= application.review_score !== null ? application.review_score : 'N/A' %></span></div>
        </div>
        <form action="/admin/hr/applications/<%= application.id %>/review" method="POST" class="mt-4 space-y-4">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div class="grid md:grid-cols-2 gap-4">
                <% rubric.forEach(item => { %>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm font-semibold text-gray-900"><%= item.label %></div>
                        <div class="text-[11px] text-gray-500"><%= item.guidance || '' %></div>
                        <div class="mt-3 flex items-center gap-3">
                            <input type="number" name="rubric_<%= item.key %>" min="0" max="5" step="0.5" value="<%= item.score !== null && typeof item.score !== 'undefined' ? item.score : '' %>" class="w-24 px-3 py-2 border border-gray-300 rounded text-sm">
                            <div class="text-xs text-gray-500">Weight <%= item.weight %></div>
                        </div>
                    </div>
                <% }) %>
            </div>
            <div class="text-right">
                <button class="btn btn-sm btn-primary">Save Rubric</button>
            </div>
        </form>
    </div>
<%- include('../../../partials/admin_footer') %>
