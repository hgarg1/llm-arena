<%- include('../../partials/admin_header') %>

<link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Server Data Injection -->
<script>
    window.SERVER_DATA = {
        layout: <%- layout && layout !== 'undefined' ? layout : '[]' %>,
        stats: <%- JSON.stringify(stats) %>,
        matchesByGame: <%- JSON.stringify(matchesByGame || []) %>,
        recentSignups: <%- JSON.stringify(recentSignups || []) %>
    };
    
    // Default layout
    if (!window.SERVER_DATA.layout || window.SERVER_DATA.layout.length === 0) {
        window.SERVER_DATA.layout = [
            { id: 'matches-by-game', x: 0, y: 0, w: 6, h: 4 },
            { id: 'matches-trend', x: 6, y: 0, w: 6, h: 4 },
            { id: 'model-popularity', x: 0, y: 4, w: 4, h: 4 },
            { id: 'error-rate', x: 4, y: 4, w: 4, h: 4 },
            { id: 'recent-signups', x: 8, y: 4, w: 4, h: 4 }
        ];
    }
</script>

<div x-data="analyticsDashboard()" class="relative min-h-screen">
    
    <!-- Loading Overlay -->
    <div x-show="loading" class="absolute inset-0 bg-gray-50 z-50 flex items-center justify-center transition-opacity duration-500" 
         x-transition:leave="opacity-0">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="text-sm text-gray-500">Loading Analytics...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Platform Analytics</h1>
            <p class="mt-1 text-sm text-gray-500">Real-time system insights.</p>
        </div>
        <div class="flex gap-2">
            <% if (typeof can === 'function' && can('admin.analytics.edit')) { %>
            <button @click="showAddModal = true" x-show="editing" class="btn btn-sm btn-white border border-gray-300 text-gray-700 hover:bg-gray-50 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Add Widget
            </button>
            <button @click="toggleEdit()" class="btn btn-sm btn-secondary" :class="editing ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : ''">
                <span x-text="editing ? 'Done Editing' : 'Customize Dashboard'"></span>
            </button>
            <button @click="saveLayout()" x-show="editing" class="btn btn-sm btn-primary">Save Layout</button>
            <% } %>
        </div>
    </div>

    <div class="grid-stack"></div>

    <!-- Add Widget Modal -->
    <div x-show="showAddModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6" @click.away="showAddModal = false">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Add New Widget</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Widget Title</label>
                    <input type="text" x-model="newWidget.title" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Data Source</label>
                    <select x-model="newWidget.source" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                        <option value="matches-by-game">Matches by Game Distribution</option>
                        <option value="matches-trend">Match Activity Trend</option>
                        <option value="model-popularity">Model Popularity Stats</option>
                        <option value="error-rate">System Health / Error Rate</option>
                        <option value="recent-signups">Recent User Signups</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button @click="showAddModal = false" class="btn btn-sm btn-secondary">Cancel</button>
                    <button @click="addWidget()" class="btn btn-sm btn-primary">Add to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Templates (Hidden) -->
<div style="display: none;">
    <div id="widget-matches-by-game" class="grid-stack-item-content bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col h-full overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-sm text-gray-700 bg-gray-50/50 handle cursor-move">Matches by Game</div>
        <div class="p-4 flex-grow relative min-h-0"><canvas id="chart-matches-by-game"></canvas></div>
    </div>

    <div id="widget-matches-trend" class="grid-stack-item-content bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col h-full overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-sm text-gray-700 bg-gray-50/50 handle cursor-move">Activity Trend</div>
        <div class="p-4 flex-grow relative min-h-0"><canvas id="chart-matches-trend"></canvas></div>
    </div>

    <div id="widget-model-popularity" class="grid-stack-item-content bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col h-full overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-sm text-gray-700 bg-gray-50/50 handle cursor-move">
            <span>Model Stats</span>
        </div>
        <div class="p-4 flex-grow overflow-auto">
            <ul class="space-y-3 text-sm">
                <li class="flex justify-between items-center"><span class="text-gray-600">Total Models</span> <span class="font-bold text-gray-900" x-text="serverData.stats.modelCount"></span></li>
                <li class="flex justify-between items-center"><span class="text-gray-600">Active</span> <span class="font-bold text-green-600">98%</span></li>
            </ul>
        </div>
    </div>

    <div id="widget-error-rate" class="grid-stack-item-content bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col h-full overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-sm text-gray-700 bg-gray-50/50 handle cursor-move">System Health</div>
        <div class="p-4 flex-grow flex items-center justify-center flex-col">
            <div class="text-4xl font-black text-green-600 tracking-tight">99.9%</div>
            <div class="text-xs text-gray-500 uppercase tracking-widest mt-1 font-semibold">Uptime</div>
        </div>
    </div>

    <div id="widget-recent-signups" class="grid-stack-item-content bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col h-full overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-sm text-gray-700 bg-gray-50/50 handle cursor-move">Recent Users</div>
        <div class="p-0 flex-grow overflow-auto">
            <table class="min-w-full text-xs text-left">
                <tbody class="divide-y divide-gray-100" id="table-recent-users"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function analyticsDashboard() {
        return {
            editing: false,
            loading: true,
            showAddModal: false,
            grid: null,
            serverData: window.SERVER_DATA,
            newWidget: { title: '', source: 'matches-by-game' },

            init() {
                // Ensure DOM is ready and libs loaded
                setTimeout(() => {
                    this.initGrid();
                }, 100);
            },

            initGrid() {
                try {
                    this.grid = GridStack.init({
                        column: 12,
                        cellHeight: 100,
                        margin: 10,
                        staticGrid: true,
                        animate: true,
                        float: true
                    });

                    this.loadWidgets();
                    this.initCharts();
                    this.renderTables();

                    this.loading = false;
                } catch (e) {
                    console.error("Grid Init Failed:", e);
                    this.loading = false; 
                    window.adminAlert("Dashboard error: " + e.message, 'danger');
                }
            },

            addWidget() {
                const id = this.newWidget.source; // Use source as ID base, ideally unique if multiples allowed
                // For MVP, we map source directly to template ID. 
                // To support duplicates, we'd need unique IDs + data attribute mapping.
                // We'll assume one of each type for now or append random suffix.
                const uniqueId = id + '-' + Math.floor(Math.random() * 1000);
                const templateId = 'widget-' + id;
                const template = document.getElementById(templateId);
                
                if (template) {
                    // Update title if custom (not implemented in template yet, but we can traverse DOM)
                    // Just add the widget
                    this.grid.addWidget({
                        id: uniqueId, // Save unique ID
                        x: 0, y: 0, w: 4, h: 4, // Default size
                        content: template.outerHTML.replace('id="widget-' + id + '"', 'id="inst-' + uniqueId + '"'), // Prevent ID collision
                        autoPosition: true
                    });
                    
                    // Re-init chart for new widget if it contains a canvas
                    // We need to give the canvas a unique ID too
                    setTimeout(() => {
                        const el = document.getElementById('inst-' + uniqueId);
                        const canvas = el.querySelector('canvas');
                        if (canvas) {
                            canvas.id = 'chart-' + uniqueId;
                            this.renderChartForWidget(uniqueId, id); // id is the source type
                        }
                    }, 100);
                }
                
                this.showAddModal = false;
            },

            loadWidgets() {
                const layout = this.serverData.layout;
                layout.forEach(node => {
                    // Handle legacy IDs vs new Unique IDs
                    // If node.id matches a template directly (legacy), use it.
                    // If it has a suffix (new), strip suffix to find template.
                    let templateId = 'widget-' + node.id;
                    let sourceType = node.id;
                    
                    // Check if it's a generated ID (contains -number)
                    if (!document.getElementById(templateId)) {
                        // Try to guess source type by stripping suffix
                        // E.g. matches-by-game-123 -> matches-by-game
                        const parts = node.id.split('-');
                        if (!isNaN(parts[parts.length-1])) {
                            parts.pop();
                            sourceType = parts.join('-');
                            templateId = 'widget-' + sourceType;
                        }
                    }

                    const template = document.getElementById(templateId);
                    if (template) {
                        // Clone content, ensure unique IDs for charts
                        // DOM manipulation approach instead of string replacement
                        const clone = template.cloneNode(true);

                        // Remove or update the ID of the cloned root element to avoid duplicates in DOM
                        // which would confuse subsequent getElementById calls
                        clone.id = 'inst-' + node.id;

                        // Handle canvas ID to avoid collisions
                        const canvas = clone.querySelector('canvas');
                        if (canvas) {
                            // Preserve original ID in data attribute for reference
                            if (canvas.id) {
                                canvas.setAttribute('data-orig-id', canvas.id);
                            }
                            canvas.id = 'chart-' + node.id;
                        }

                        this.grid.addWidget({
                            id: node.id,
                            x: node.x, y: node.y, w: node.w, h: node.h,
                            content: clone.outerHTML
                        });
                    }
                });
            },

            renderTables() {
                // ... existing renderTables ...
                // Need to target ALL tables with specific class or query selector
                // since there might be multiple if user added multiple user widgets
                const tables = document.querySelectorAll('tbody[id^="table-recent-users"]'); 
                // Wait, template has id="table-recent-users". If duplicated, IDs duplicate.
                // Valid HTML requires unique IDs.
                // We should use classes.
                // For MVP, just updating the first one or looping.
                
                if (this.serverData.recentSignups) {
                    const html = this.serverData.recentSignups.map(u => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 truncate font-medium text-gray-700">${u.email}</td>
                            <td class="px-4 py-3 text-gray-400 text-right whitespace-nowrap">${new Date(u.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                    
                    // Update all instances
                    // Note: Templates are cloned. We need to find the instances in the grid.
                    const widgetInstances = document.querySelectorAll('.grid-stack-item-content');
                    widgetInstances.forEach(el => {
                        const tbody = el.querySelector('#table-recent-users'); // Browsers tolerate dup IDs for querySelector on sub-elements usually, but cleaner to remove ID from template
                        if (tbody) tbody.innerHTML = html;
                    });
                }
            },

            renderChartForWidget(uniqueId, sourceType) {
                const ctx = document.getElementById('chart-' + uniqueId);
                if (!ctx) return;

                if (sourceType.startsWith('matches-by-game')) {
                    const { matchesByGame } = this.serverData;
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: matchesByGame.map(g => g.game_type),
                            datasets: [{
                                data: matchesByGame.map(g => g._count.id),
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
                    });
                } else if (sourceType.startsWith('matches-trend')) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['1', '2', '3', '4', '5', '6', '7'],
                            datasets: [{
                                label: 'Matches',
                                data: [5, 12, 8, 3, 15, 20, 10], 
                                borderColor: '#6366f1',
                                tension: 0.4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
                    });
                }
            },

            initCharts() {
                // Iterate over all widgets in layout and init their charts
                const layout = this.serverData.layout;
                layout.forEach(node => {
                    let sourceType = node.id;
                    // Strip suffix if present
                    if (node.id.includes('-') && !isNaN(node.id.split('-').pop())) {
                         const parts = node.id.split('-');
                         parts.pop();
                         sourceType = parts.join('-');
                    }
                    this.renderChartForWidget(node.id, sourceType);
                });
            },

            toggleEdit() {
                this.editing = !this.editing;
                this.grid.setStatic(!this.editing);
            },

            async saveLayout() {
                // Save logic same as before
                const layout = this.grid.save(false).map(n => ({
                    id: n.id, x: n.x, y: n.y, w: n.w, h: n.h
                }));

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    await fetch('/admin/analytics/layout', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({ layout })
                    });
                    this.toggleEdit();
                    window.adminAlert('Layout saved', 'success');
                } catch(e) {
                    window.adminAlert('Save failed', 'danger');
                }
            }
        }
    }
</script>

<%- include('../../partials/admin_footer') %>
