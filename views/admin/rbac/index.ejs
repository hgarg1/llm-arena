<%- include('../../partials/admin_header') %>
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">RBAC</h1>
        <p class="text-sm text-gray-500">Configure roles, groups, and per-user overrides.</p>
    </div>

    <% if (success) { %>
        <div class="mb-6 rounded-md bg-green-50 p-4 border border-green-200 text-green-700 text-sm"><%= success %></div>
    <% } %>
    <% if (error) { %>
        <div class="mb-6 rounded-md bg-red-50 p-4 border border-red-200 text-red-700 text-sm"><%= error %></div>
    <% } %>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Roles -->
        <section class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-900">Roles</h3>
                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <form action="/admin/rbac/roles" method="POST" class="flex gap-2">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="text" name="name" placeholder="Role name" class="px-2 py-1 border border-gray-300 rounded text-xs" required>
                    <button class="btn btn-xs btn-secondary">Add</button>
                </form>
                <% } %>
            </div>

            <form action="/admin/rbac/roles/permissions/<%= selectedRole ? selectedRole.id : '' %>" method="POST" onsubmit="this.role_id.value = this.querySelector('select[name=role]').value">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-600">Select role</label>
                    <select id="roleSelect" name="role" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <% roles.forEach(r => { %>
                            <option value="<%= r.id %>" <%= selectedRole && selectedRole.id === r.id ? 'selected' : '' %>><%= r.name %></option>
                        <% }) %>
                    </select>
                    <div class="mt-2 flex items-center gap-2">
                        <button type="button" class="btn btn-xs btn-ghost" onclick="const sel=document.getElementById('roleSelect'); if(sel){ window.location.href='/admin/rbac?role=' + sel.value + '<%= selectedGroup ? '&group=' + selectedGroup.id : '' %><%= selectedUser ? '&user=' + selectedUser.id : '' %>';}">Load role</button>
                    </div>
                </div>
                <input type="hidden" name="role_id" value="<%= selectedRole ? selectedRole.id : '' %>">

                <% if (selectedRole) { %>
                <div class="space-y-2 max-h-[420px] overflow-y-auto border border-gray-100 rounded p-3">
                    <% permissions.forEach(p => { 
                        const existing = selectedRole.permissions.find(rp => rp.permission.key === p.key);
                        const effect = existing ? existing.effect : 'NONE';
                    %>
                        <div class="flex items-center justify-between text-xs border-b border-gray-50 py-2">
                            <div>
                                <div class="font-mono text-[11px] text-gray-700"><%= p.key %></div>
                                <div class="text-gray-400"><%= p.description || '' %></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="perm[<%= p.key %>]" value="allow" <%= effect === 'ALLOW' ? 'checked' : '' %>>
                                    Allow
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="perm[<%= p.key %>]" value="deny" <%= effect === 'DENY' ? 'checked' : '' %>>
                                    Deny
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="perm[<%= p.key %>]" value="none" <%= effect === 'NONE' ? 'checked' : '' %>>
                                    None
                                </label>
                            </div>
                        </div>
                    <% }) %>
                </div>

                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <div class="text-right mt-4">
                    <button class="btn btn-sm btn-primary">Save Role Permissions</button>
                </div>
                <% } %>
                <% } %>
            </form>
        </section>

        <!-- Groups -->
        <section class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-900">Groups</h3>
                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <form action="/admin/rbac/groups" method="POST" class="flex gap-2">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="text" name="name" placeholder="Group name" class="px-2 py-1 border border-gray-300 rounded text-xs" required>
                    <button class="btn btn-xs btn-secondary">Add</button>
                </form>
                <% } %>
            </div>

            <form action="/admin/rbac/groups/<%= selectedGroup ? selectedGroup.id : '' %>/roles" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-600">Select group</label>
                    <select name="group" class="w-full px-3 py-2 border border-gray-300 rounded" onchange="window.location.href='/admin/rbac?group=' + this.value + '<%= selectedRole ? '&role=' + selectedRole.id : '' %><%= selectedUser ? '&user=' + selectedUser.id : '' %>'">
                        <% groups.forEach(g => { %>
                            <option value="<%= g.id %>" <%= selectedGroup && selectedGroup.id === g.id ? 'selected' : '' %>><%= g.name %></option>
                        <% }) %>
                    </select>
                </div>

                <% if (selectedGroup) { %>
                <div class="space-y-2">
                    <% roles.forEach(r => { 
                        const hasRole = selectedGroup.roles.find(gr => gr.role.id === r.id);
                    %>
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" name="role_ids" value="<%= r.id %>" <%= hasRole ? 'checked' : '' %>>
                            <span><%= r.name %></span>
                        </label>
                    <% }) %>
                </div>

                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <div class="text-right mt-4">
                    <button class="btn btn-sm btn-primary">Save Group Roles</button>
                </div>
                <% } %>
                <% } %>
            </form>
        </section>
    </div>

    <!-- User Assignments -->
    <section class="mt-8 bg-white rounded-lg shadow border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-gray-900">User Assignments & Overrides</h3>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <div>
                <label class="text-xs font-medium text-gray-600">Select user</label>
                <form method="GET" action="/admin/rbac" class="flex flex-col gap-2">
                    <select name="user" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <option value="">Select...</option>
                        <% users.forEach(u => { %>
                            <option value="<%= u.id %>" <%= selectedUser && selectedUser.id === u.id ? 'selected' : '' %>><%= u.email %></option>
                        <% }) %>
                    </select>
                    <% if (userQuery) { %>
                        <input type="hidden" name="user_q" value="<%= userQuery %>">
                    <% } %>
                    <% if (selectedRole) { %>
                        <input type="hidden" name="role" value="<%= selectedRole.id %>">
                    <% } %>
                    <% if (selectedGroup) { %>
                        <input type="hidden" name="group" value="<%= selectedGroup.id %>">
                    <% } %>
                    <button class="btn btn-sm btn-secondary w-fit">Load user</button>
                </form>
            </div>
            <div class="md:col-span-2">
                <label class="text-xs font-medium text-gray-600">Search users</label>
                <form method="GET" action="/admin/rbac" class="flex gap-2">
                    <input type="text" name="user_q" value="<%= userQuery || '' %>" placeholder="Email or user id" class="w-full px-3 py-2 border border-gray-300 rounded">
                    <% if (selectedUser) { %>
                        <input type="hidden" name="user" value="<%= selectedUser.id %>">
                    <% } %>
                    <% if (selectedRole) { %>
                        <input type="hidden" name="role" value="<%= selectedRole.id %>">
                    <% } %>
                    <% if (selectedGroup) { %>
                        <input type="hidden" name="group" value="<%= selectedGroup.id %>">
                    <% } %>
                    <button class="btn btn-sm btn-secondary">Search</button>
                </form>
            </div>
        </div>

        <% if (selectedUser) { %>
        <div class="mt-6">
            <h4 class="text-sm font-semibold text-gray-800">Effective Permissions</h4>
            <p class="text-xs text-gray-500">Calculated from roles, groups, and overrides. Overrides take precedence.</p>
            <% if (selectedUser.role === 'ADMIN' && selectedUserHasAssignments) { %>
                <div class="mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-100 rounded px-3 py-2">
                    ADMIN implicit access is disabled once RBAC assignments or overrides exist. Grant permissions explicitly.
                </div>
            <% } %>
            <div class="mt-3 max-h-[260px] overflow-y-auto border border-gray-100 rounded p-3 bg-gray-50">
                <div class="space-y-2">
                    <% selectedUserEffective.forEach(ep => { %>
                        <div class="flex items-center justify-between text-xs border-b border-gray-100 py-2">
                            <div>
                                <div class="font-mono text-[11px] text-gray-700"><%= ep.key %></div>
                                <div class="text-gray-400"><%= ep.source %></div>
                            </div>
                            <div class="uppercase text-[10px] font-semibold px-2 py-1 rounded
                                <%= ep.effect === 'ALLOW' ? 'bg-green-100 text-green-700' : ep.effect === 'DENY' ? 'bg-red-100 text-red-700' : 'bg-gray-200 text-gray-600' %>">
                                <%= ep.effect %>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8 mt-6">
            <form action="/admin/rbac/users/<%= selectedUser.id %>/assignments" method="POST" class="space-y-4">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div>
                    <label class="text-xs font-medium text-gray-600">Roles</label>
                    <div class="space-y-2 mt-2">
                        <% roles.forEach(r => { 
                            const hasRole = selectedUser.rbac_roles.find(ur => ur.role.id === r.id);
                        %>
                            <label class="flex items-center gap-2 text-sm text-gray-700">
                                <input type="checkbox" name="role_ids" value="<%= r.id %>" <%= hasRole ? 'checked' : '' %>>
                                <span><%= r.name %></span>
                            </label>
                        <% }) %>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-600">Groups</label>
                    <div class="space-y-2 mt-2">
                        <% groups.forEach(g => { 
                            const hasGroup = selectedUser.rbac_groups.find(ug => ug.group.id === g.id);
                        %>
                            <label class="flex items-center gap-2 text-sm text-gray-700">
                                <input type="checkbox" name="group_ids" value="<%= g.id %>" <%= hasGroup ? 'checked' : '' %>>
                                <span><%= g.name %></span>
                            </label>
                        <% }) %>
                    </div>
                </div>

                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <div class="text-right">
                    <button class="btn btn-sm btn-primary">Save Assignments</button>
                </div>
                <% } %>
            </form>

            <form action="/admin/rbac/users/<%= selectedUser.id %>/overrides" method="POST" class="space-y-4">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="max-h-[420px] overflow-y-auto border border-gray-100 rounded p-3">
                    <% permissions.forEach(p => { 
                        const existing = selectedUser.rbac_permission_overrides.find(po => po.permission.key === p.key);
                        const effect = existing ? existing.effect : 'NONE';
                    %>
                        <div class="flex items-center justify-between text-xs border-b border-gray-50 py-2">
                            <div>
                                <div class="font-mono text-[11px] text-gray-700"><%= p.key %></div>
                                <div class="text-gray-400"><%= p.description || '' %></div>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="override[<%= p.key %>]" value="allow" <%= effect === 'ALLOW' ? 'checked' : '' %>>
                                    Allow
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="override[<%= p.key %>]" value="deny" <%= effect === 'DENY' ? 'checked' : '' %>>
                                    Deny
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="override[<%= p.key %>]" value="none" <%= effect === 'NONE' ? 'checked' : '' %>>
                                    None
                                </label>
                            </div>
                        </div>
                    <% }) %>
                </div>
                <% if (typeof can === 'function' && can('admin.rbac.edit')) { %>
                <div class="text-right">
                    <button class="btn btn-sm btn-primary">Save Overrides</button>
                </div>
                <% } %>
            </form>
        </div>
        <% } %>
    </section>
    <script>
        (function () {
            const select = document.getElementById('roleSelect');
            const output = document.getElementById('roleSelectedId');
            const hidden = document.querySelector('input[name="role_id"]');
            if (!select) return;
            select.addEventListener('change', () => {
                if (output) output.textContent = select.value || '';
                if (hidden) hidden.value = select.value || '';
            });
        })();
    </script>
<%- include('../../partials/admin_footer') %>
