// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum MatchStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum TournamentStatus {
  PENDING
  RUNNING
  COMPLETED
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum ModelKind {
  SINGLE
  COMPOSITE
}

enum CompositeStrategy {
  ROUND_ROBIN
  RANDOM
  FALLBACK
  PIPELINE
}

enum PermissionEffect {
  ALLOW
  DENY
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum EntitlementValueType {
  BOOL
  NUMBER
  STRING
  ENUM
  JSON
}

enum EntitlementOverrideTarget {
  ORG
  USER
  PLAN
}

enum EntitlementAuditAction {
  CREATE
  UPDATE
  DELETE
}

enum UsageScopeType {
  USER
  ORG
  API_KEY
  MODEL
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  SUSPENDED
}

enum StripePriceStatus {
  ACTIVE
  INACTIVE
  LEGACY
}

enum StripeSubscriptionTarget {
  USER
  ORG
}

enum StripeMode {
  TEST
  LIVE
}
enum GameStatus {
  DRAFT
  SCHEDULED
  LIVE
  RETIRED
}

enum GameSettingType {
  BOOLEAN
  INT
  FLOAT
  ENUM
  TEXT
}

enum GameEngineArtifactStatus {
  DRAFT
  PUBLISHED
  FAILED
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum JobEmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  TEMP
}

enum JobLocationType {
  ONSITE
  REMOTE
  HYBRID
}

enum JobQuestionType {
  SHORT_TEXT
  LONG_TEXT
  SELECT
  MULTISELECT
  BOOLEAN
}

enum JobApplicationStatus {
  NEW
  IN_REVIEW
  INTERVIEW
  OFFER
  HIRED
  REJECTED
}

enum JobInterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELED
  NO_SHOW
  RESCHEDULE
}

model GameDryRun {
  id         String   @id @default(uuid())
  game_id    String
  seed       Int
  events     Json
  created_by String?
  created_at DateTime @default(now())

  game       GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String?   // Optional because SSO users might not have one initially
  
  // Profile
  name          String?
  company       String?
  job_title     String?
  avatar_url    String?   // Profile Picture
  tier          SubscriptionTier @default(FREE)
  plan_id       String?
  plan          SubscriptionPlan? @relation(fields: [plan_id], references: [id], onDelete: SetNull)
  stripe_customer_id String?
  org_id        String?
  organization  Organization? @relation(fields: [org_id], references: [id], onDelete: SetNull)

  // Auth
  role          Role      @default(USER)
  banned        Boolean   @default(false)
  reset_token   String?
  reset_token_expires DateTime?
  
  // Verification
  email_verified Boolean  @default(false)
  email_verification_token String?
  
  phone         String?   @unique
  phone_verified Boolean  @default(false)
  phone_verification_code String?
  phone_verification_expires DateTime?

  // MFA (TOTP)
  mfa_secret    String?
  mfa_enabled   Boolean   @default(false)
  mfa_backup_codes String[] @default([])

  // SSO IDs
  google_id     String?   @unique
  microsoft_id  String?   @unique
  apple_id      String?   @unique

  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  models        Model[]
  matches       Match[]   // Matches created by user
  api_keys      ApiKey[]
  api_key_audits ApiKeyAuditLog[]
    passkeys      Passkey[]
    dashboard     AdminDashboard?
    admin_audit_logs AdminAuditLog[] @relation("AdminAuditLogs")
    access_requests_sent AdminAccessRequest[] @relation("AccessRequestRequester")
    access_requests_reviewed AdminAccessRequest[] @relation("AccessRequestReviewer")
    entitlement_overrides_created EntitlementOverride[] @relation("EntitlementOverrideCreator")
    entitlement_audit_logs EntitlementAuditLog[] @relation("EntitlementAuditActor")
    stripe_products_created SubscriptionPlanStripeProduct[] @relation("StripeProductCreator")
    stripe_prices_created SubscriptionPlanPrice[] @relation("StripePriceCreator")
    jobs_created JobPosting[] @relation("JobCreator")
    rbac_roles    RbacUserRole[]
  rbac_groups   RbacUserGroup[]
  rbac_permission_overrides RbacUserPermissionOverride[]
  
  chat_channels_created ChatChannel[] @relation("ChannelCreator")
  chat_participations   ChatParticipant[]
  chat_messages         ChatMessage[]
  chat_notifications    ChatNotification[]
  chat_audit_logs       ChatAuditLog[]
  admin_ai_chats        AdminAiChat[]

  // Chat/Notification Settings
  chat_notifications_enabled Boolean @default(true)
  chat_notifications_sound   Boolean @default(true)
  chat_notifications_rate_limit Int @default(5) // Seconds between toasts
  chat_presence_visible      Boolean @default(true)
  
  // Blocking
  can_block_people           Boolean @default(true)
  blocked_users              UserBlock[] @relation("UserBlocking")
  blocked_by                 UserBlock[] @relation("UserBlockedBy")
}

model UserBlock {
  id          String   @id @default(uuid())
  blocker_id  String
  blocked_id  String
  created_at  DateTime @default(now())

  blocker     User     @relation("UserBlocking", fields: [blocker_id], references: [id], onDelete: Cascade)
  blocked     User     @relation("UserBlockedBy", fields: [blocked_id], references: [id], onDelete: Cascade)

  @@unique([blocker_id, blocked_id])
  @@index([blocker_id])
  @@index([blocked_id])
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  plan_id    String?
  plan       SubscriptionPlan? @relation(fields: [plan_id], references: [id], onDelete: SetNull)
  stripe_customer_id String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  users      User[]
}

model Passkey {
  id              String   @id @default(uuid())
  credential_id   String   @unique // base64url encoded
  public_key      String   // base64url encoded
  counter         BigInt
  transports      String[] // e.g. ["internal", "usb"]
  created_at      DateTime @default(now())
  last_used       DateTime?
  user_id         String
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model ApiKey {
  id          String   @id @default(uuid())
  key_hash    String   @unique
  name        String
  prefix      String?
  status      ApiKeyStatus @default(ACTIVE)
  last_used   DateTime?
  expires_at  DateTime?
  created_at  DateTime @default(now())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  scopes      ApiKeyScope[]
  usage       ApiKeyUsage[]
  audits      ApiKeyAuditLog[]
}

model ApiKeyScope {
  id         String   @id @default(uuid())
  key_id     String
  scope_key  String
  created_at DateTime @default(now())
  api_key    ApiKey   @relation(fields: [key_id], references: [id], onDelete: Cascade)

  @@unique([key_id, scope_key])
  @@index([scope_key])
}

model ApiKeyUsage {
  id           String   @id @default(uuid())
  key_id       String
  route        String
  method       String
  status_code  Int
  window_start DateTime
  count        Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  api_key      ApiKey   @relation(fields: [key_id], references: [id], onDelete: Cascade)

  @@index([key_id, window_start])
  @@unique([key_id, route, method, status_code, window_start])
}

model ApiKeyAuditLog {
  id            String   @id @default(uuid())
  actor_user_id String
  target_key_id String
  action        String
  before        Json?
  after         Json?
  created_at    DateTime @default(now())
  actor         User     @relation(fields: [actor_user_id], references: [id], onDelete: Cascade)
  api_key       ApiKey   @relation(fields: [target_key_id], references: [id], onDelete: Cascade)

  @@index([target_key_id, created_at])
}

model Model {
  id            String    @id @default(uuid())
  name          String
  description   String?
  api_provider  String    // e.g., "openai", "mock"
  api_model_id  String    // e.g., "gpt-4", "mock-v1"
  kind          ModelKind @default(SINGLE)
  is_active     Boolean   @default(true)
  owner_id      String?
  owner         User?     @relation(fields: [owner_id], references: [id])
  capabilities  String[]  @default([])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  
  match_participations MatchParticipant[]
  composite     ModelComposite?
  composite_members ModelCompositeMember[] @relation("CompositeMembers")
  pipeline_members ModelPipelineStep[] @relation("PipelineMembers")
}

model Tournament {
  id          String           @id @default(uuid())
  name        String
  status      TournamentStatus @default(PENDING)
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
  
  matches     Match[]
}

model Match {
  id              String      @id @default(uuid())
  tournament_id   String?
  tournament      Tournament? @relation(fields: [tournament_id], references: [id])
  
  created_by_id   String?
  created_by      User?       @relation(fields: [created_by_id], references: [id])

  game_type       String      // e.g., "iterated-negotiation"
  status          MatchStatus @default(PENDING)
  seed            Int         // Deterministic seed
  ruleset_version String      @default("1.0.0")
  
  created_at      DateTime    @default(now())
  finished_at     DateTime?
  
  participants    MatchParticipant[]
  events          MatchEvent[]
}

model MatchParticipant {
  id        String   @id @default(uuid())
  match_id  String
  match     Match    @relation(fields: [match_id], references: [id])
  model_id  String
  model     Model    @relation(fields: [model_id], references: [id])
  
  role      String?  // e.g. "player1", "white", "black"
  score     Int?
  
  created_at DateTime @default(now())
}

model MatchEvent {
  id          String   @id @default(uuid())
  match_id    String
  match       Match    @relation(fields: [match_id], references: [id])
  
  turn_index  Int
  actor_role  String?  // e.g., "player1", "player2", "system"
  type        String   // e.g., "proposal", "accept", "reject", "game_start", "game_end"
  payload     Json
  
  created_at  DateTime @default(now())

  @@index([match_id, turn_index])
}

model ModelComposite {
  id        String   @id @default(uuid())
  model_id  String   @unique
  strategy  CompositeStrategy @default(ROUND_ROBIN)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  model     Model    @relation(fields: [model_id], references: [id], onDelete: Cascade)
  members   ModelCompositeMember[]
  pipeline_steps ModelPipelineStep[]
}

model ModelCompositeMember {
  id              String   @id @default(uuid())
  composite_id    String
  member_model_id String
  weight          Int      @default(1)
  position        Int      @default(0)
  composite       ModelComposite @relation(fields: [composite_id], references: [id], onDelete: Cascade)
  member          Model          @relation("CompositeMembers", fields: [member_model_id], references: [id], onDelete: Cascade)

  @@unique([composite_id, member_model_id])
  @@index([composite_id, position])
}

model ModelPipelineStep {
  id            String   @id @default(uuid())
  composite_id  String
  member_model_id String
  position      Int      @default(0)
  prompt_template String? @db.Text
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  composite     ModelComposite @relation(fields: [composite_id], references: [id], onDelete: Cascade)
  member        Model @relation("PipelineMembers", fields: [member_model_id], references: [id], onDelete: Cascade)

  @@unique([composite_id, member_model_id])
  @@index([composite_id, position])
}

model SystemSetting {
  key   String @id
  value String
  updated_at DateTime @updatedAt
}

model AdminDashboard {
  id        String   @id @default(uuid())
  user_id   String   @unique
  layout    Json     // Array of widget configs { id, type, x, y, w, h }
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  admin_id  String
  action    String
  target    String?
  metadata  Json?
  created_at DateTime @default(now())
  admin     User     @relation("AdminAuditLogs", fields: [admin_id], references: [id], onDelete: Cascade)
}

model AdminAccessRequest {
  id             String             @id @default(uuid())
  requester_id   String
  permission_key String
  path           String?
  method         String?
  reason         String?
  status         AccessRequestStatus @default(PENDING)
  reviewed_by    String?
  reviewed_at    DateTime?
  created_at     DateTime           @default(now())
  requester      User               @relation("AccessRequestRequester", fields: [requester_id], references: [id], onDelete: Cascade)
  reviewer       User?              @relation("AccessRequestReviewer", fields: [reviewed_by], references: [id], onDelete: SetNull)

  @@index([status, created_at])
  @@index([permission_key])
}

model RbacRole {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  permissions RbacRolePermission[]
  user_roles  RbacUserRole[]
  group_roles RbacGroupRole[]
}

model RbacPermission {
  id          String   @id @default(uuid())
  key         String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  role_permissions RbacRolePermission[]
  user_overrides  RbacUserPermissionOverride[]
}

model RbacRolePermission {
  id            String   @id @default(uuid())
  role_id       String
  permission_id String
  effect        PermissionEffect
  role          RbacRole       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission    RbacPermission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([role_id, permission_id])
}

model RbacGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  roles       RbacGroupRole[]
  users       RbacUserGroup[]
}

model RbacGroupRole {
  id       String @id @default(uuid())
  group_id String
  role_id  String
  group    RbacGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  role     RbacRole  @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@unique([group_id, role_id])
}

model RbacUserRole {
  id      String @id @default(uuid())
  user_id String
  role_id String
  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role    RbacRole @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role_id])
}

model RbacUserGroup {
  id       String @id @default(uuid())
  user_id  String
  group_id String
  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  group    RbacGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@unique([user_id, group_id])
}

model RbacUserPermissionOverride {
  id            String @id @default(uuid())
  user_id       String
  permission_id String
  effect        PermissionEffect
  user          User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  permission    RbacPermission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([user_id, permission_id])
}

model ContentBlock {
  key       String   @id // e.g. "investor_hero_title"
  value     String   @db.Text
  updated_at DateTime @updatedAt
  updated_by String?
}

model GameDefinition {
  id                String   @id @default(uuid())
  key               String   @unique
  name              String
  description_short String?
  description_long  String?
  status            GameStatus @default(DRAFT)
  capabilities      String[] @default([])
  roles             String[] @default([])
  max_players       Int?
  assets            Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  settings          GameSetting[]
  ui_schema         GameUISchema?
  releases          GameRelease[]
  revisions         GameRevision[]
  engine_artifacts  GameEngineArtifact[]
  dry_runs          GameDryRun[]
}

model GameSetting {
  id            String   @id @default(uuid())
  game_id       String
  key           String
  type          GameSettingType
  min_value     Json?
  max_value     Json?
  default_value Json?
  enum_options  String[] @default([])
  tier_required SubscriptionTier @default(FREE)
  help_text     String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  game          GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)

  @@unique([game_id, key])
}

model GameUISchema {
  id                 String   @id @default(uuid())
  game_id            String   @unique
  create_form_layout Json?
  summary_template   Json?
  labels             Json?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  game               GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)
}

model GameRelease {
  id          String   @id @default(uuid())
  game_id     String
  status      GameStatus @default(DRAFT)
  publish_at  DateTime?
  published_by String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  game        GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)
}

model GameRevision {
  id         String   @id @default(uuid())
  game_id    String
  revision   Int
  snapshot   Json
  created_by String?
  created_at DateTime @default(now())

  game       GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)

  @@unique([game_id, revision])
}

model GameEngineArtifact {
  id         String   @id @default(uuid())
  game_id    String
  status     GameEngineArtifactStatus @default(DRAFT)
  spec       Json
  code_ts    String   @db.Text
  tests_ts   String?  @db.Text
  notes      String?  @db.Text
  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  game       GameDefinition @relation(fields: [game_id], references: [id], onDelete: Cascade)
}

model JobPosting {
  id               String   @id @default(uuid())
  title            String
  slug             String   @unique
  summary          String
  description      String   @db.Text
  location         String?
  location_type    JobLocationType @default(REMOTE)
  employment_type  JobEmploymentType @default(FULL_TIME)
  department       String?
  seniority        String?
  status           JobStatus @default(DRAFT)
  featured         Boolean  @default(false)
  application_schema Json?
  review_rubric    Json?
  created_by       String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  applications     JobApplication[]
  questions        JobQuestion[]
  creator          User? @relation("JobCreator", fields: [created_by], references: [id], onDelete: SetNull)

  @@index([status, created_at])
}

model JobQuestion {
  id         String   @id @default(uuid())
  job_id     String
  key        String
  label      String
  type       JobQuestionType @default(SHORT_TEXT)
  required   Boolean  @default(false)
  options    String[] @default([])
  position   Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  job        JobPosting @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@unique([job_id, key])
  @@index([job_id, position])
}

model JobApplication {
  id              String   @id @default(uuid())
  job_id          String
  full_name       String
  email           String
  phone           String?
  location        String?
  linkedin_url    String?
  github_url      String?
  portfolio_url   String?
  resume_path     String?
  resume_blob_url String?
  resume_text     String?
  ai_extract      Json?
  ai_sentiment_application Json?
  ai_sentiment_fit Json?
  ai_sentiment_score Float?
  ai_fit_score    Float?
  review_rubric   Json?
  review_score    Float?
  interview_status JobInterviewStatus?
  interview_scheduled_at DateTime?
  interview_location String?
  interview_notes String?
  last_contacted_at DateTime?
  admin_notes     String?  @db.Text
  status          JobApplicationStatus @default(NEW)
  source          String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  job             JobPosting @relation(fields: [job_id], references: [id], onDelete: Cascade)
  answers         JobApplicationAnswer[]

  @@index([job_id, status, created_at])
  @@index([email])
}

model JobApplicationAnswer {
  id              String   @id @default(uuid())
  application_id  String
  question_key    String
  question_label  String
  response        Json?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  application     JobApplication @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@index([application_id])
}

model SubscriptionEntitlement {
  id          String   @id @default(uuid())
  key         String   @unique
  description String?
  value_type  EntitlementValueType @default(BOOL)
  default_value Json?
  validation_schema Json?
  category_id String?
  usage_limit Int?
  usage_unit  String?
  usage_period String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  tiers       SubscriptionTierEntitlement[]
  plans       SubscriptionPlanEntitlement[]
  category    SubscriptionEntitlementCategory? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  dependencies SubscriptionEntitlementDependency[] @relation("EntitlementDeps")
  dependents   SubscriptionEntitlementDependency[] @relation("EntitlementDependents")
  overrides   EntitlementOverride[]
  audit_logs  EntitlementAuditLog[]
  usage_counters UsageCounter[]
}

model SubscriptionTierEntitlement {
  id             String   @id @default(uuid())
  entitlement_id String
  tier           SubscriptionTier
  enabled        Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  entitlement    SubscriptionEntitlement @relation(fields: [entitlement_id], references: [id], onDelete: Cascade)

  @@unique([entitlement_id, tier])
}

model SubscriptionPlan {
  id                String   @id @default(uuid())
  key               String   @unique
  name              String
  description_short String
  description_long  String
  price_cents       Int?
  currency          String?  @default("USD")
  interval          String?  @default("month")
  level             Int      @default(1)
  is_active         Boolean  @default(true)
  stripe_product_id String?
  stripe_product_active Boolean?
  stripe_product_metadata Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  entitlements      SubscriptionPlanEntitlement[]
  stripe_products   SubscriptionPlanStripeProduct[]
  prices            SubscriptionPlanPrice[]
  subscriptions     StripeSubscription[]
  users             User[]
  organizations     Organization[]
}

model SubscriptionPlanStripeProduct {
  id                String   @id @default(uuid())
  plan_id           String
  stripe_product_id String   @unique
  mode              StripeMode
  active            Boolean  @default(true)
  metadata          Json?
  created_by        String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  plan              SubscriptionPlan @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  creator           User? @relation("StripeProductCreator", fields: [created_by], references: [id], onDelete: SetNull)

  @@unique([plan_id, mode])
  @@index([plan_id, mode, active])
}

model SubscriptionPlanPrice {
  id               String   @id @default(uuid())
  plan_id          String
  stripe_price_id  String   @unique
  stripe_product_id String?
  nickname         String?
  currency         String?
  unit_amount      Int?
  interval         String?
  interval_count   Int?
  status           StripePriceStatus @default(ACTIVE)
  is_default       Boolean  @default(false)
  stripe_active    Boolean?
  metadata         Json?
  mode             StripeMode @default(TEST)
  created_by       String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  plan             SubscriptionPlan @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  creator          User? @relation("StripePriceCreator", fields: [created_by], references: [id], onDelete: SetNull)

  @@index([plan_id, status])
  @@index([plan_id, mode, status])
}

model StripeSubscription {
  id                     String   @id @default(uuid())
  stripe_subscription_id String   @unique
  stripe_customer_id     String
  stripe_mode            StripeMode @default(TEST)
  status                 String
  plan_id                String?
  price_id               String?
  product_id             String?
  target_type            StripeSubscriptionTarget
  target_id              String
  current_period_start   DateTime?
  current_period_end     DateTime?
  cancel_at_period_end   Boolean  @default(false)
  canceled_at            DateTime?
  trial_end              DateTime?
  quantity               Int?
  raw                    Json?
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  plan                   SubscriptionPlan? @relation(fields: [plan_id], references: [id], onDelete: SetNull)

  @@index([target_type, target_id])
  @@index([stripe_customer_id])
}

model SubscriptionPlanEntitlement {
  id             String   @id @default(uuid())
  plan_id        String
  entitlement_id String
  enabled        Boolean  @default(false)
  value          Json?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  plan           SubscriptionPlan @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  entitlement    SubscriptionEntitlement @relation(fields: [entitlement_id], references: [id], onDelete: Cascade)

  @@unique([plan_id, entitlement_id])
}

model SubscriptionEntitlementCategory {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  entitlements SubscriptionEntitlement[]
}

model SubscriptionEntitlementDependency {
  id               String @id @default(uuid())
  entitlement_id   String
  depends_on_id    String

  entitlement      SubscriptionEntitlement @relation("EntitlementDeps", fields: [entitlement_id], references: [id], onDelete: Cascade)
  depends_on       SubscriptionEntitlement @relation("EntitlementDependents", fields: [depends_on_id], references: [id], onDelete: Cascade)

  @@unique([entitlement_id, depends_on_id])
}

model EntitlementOverride {
  id             String   @id @default(uuid())
  target_type    EntitlementOverrideTarget
  target_id      String
  entitlement_key String
  enabled        Boolean  @default(true)
  value          Json?
  starts_at      DateTime?
  ends_at        DateTime?
  created_by     String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  entitlement    SubscriptionEntitlement @relation(fields: [entitlement_key], references: [key], onDelete: Cascade)
  creator        User? @relation("EntitlementOverrideCreator", fields: [created_by], references: [id], onDelete: SetNull)

  @@index([target_type, target_id])
  @@index([entitlement_key])
}

model EntitlementAuditLog {
  id             String   @id @default(uuid())
  actor_user_id  String
  target_type    EntitlementOverrideTarget
  target_id      String
  entitlement_key String
  action         EntitlementAuditAction
  before_value   Json?
  after_value    Json?
  before_enabled Boolean?
  after_enabled  Boolean?
  created_at     DateTime @default(now())

  actor          User @relation("EntitlementAuditActor", fields: [actor_user_id], references: [id], onDelete: Cascade)
  entitlement    SubscriptionEntitlement @relation(fields: [entitlement_key], references: [key], onDelete: Cascade)

  @@index([entitlement_key, created_at])
}

model UsageCounter {
  id              String   @id @default(uuid())
  scope_type      UsageScopeType
  scope_id        String
  entitlement_key String
  window_start    DateTime
  count           Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  entitlement    SubscriptionEntitlement @relation(fields: [entitlement_key], references: [key], onDelete: Cascade)

  @@unique([scope_type, scope_id, entitlement_key, window_start])
  @@index([entitlement_key, window_start])
}

enum ChatChannelType {
  PUBLIC
  PRIVATE
  SUPPORT
  SYSTEM
  ANNOUNCEMENT
}

enum ChatMemberRole {
  OWNER
  ADMIN
  MEMBER
  READONLY
}

enum ChatMessageType {
  TEXT
  SYSTEM
  IMAGE
  FILE
}

model ChatChannel {
  id                    String   @id @default(uuid())
  name                  String
  slug                  String   @unique
  description           String?
  type                  ChatChannelType @default(PUBLIC)
  is_archived           Boolean  @default(false)
  is_read_only          Boolean  @default(false)
  rate_limit            Int      @default(0)
  min_role_required     String?  // Reference to RbacRole.name
  entitlement_required  String?  // Reference to SubscriptionEntitlement.key
  created_by            String?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  creator               User?    @relation("ChannelCreator", fields: [created_by], references: [id], onDelete: SetNull)
  participants          ChatParticipant[]
  messages              ChatMessage[]
  notifications         ChatNotification[]
}

model ChatParticipant {
  id          String   @id @default(uuid())
  channel_id  String
  user_id     String
  role        ChatMemberRole @default(MEMBER)
  joined_at   DateTime @default(now())
  last_read_at DateTime?

  channel     ChatChannel @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([channel_id, user_id])
}

model ChatMessage {
  id          String   @id @default(uuid())
  channel_id  String
  user_id     String?  // Null for system messages
  type        ChatMessageType @default(TEXT)
  content     String   @db.Text
  is_pinned   Boolean  @default(false)
  is_edited   Boolean  @default(false)
  deleted_at  DateTime?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  channel     ChatChannel @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  sender      User?       @relation(fields: [user_id], references: [id], onDelete: SetNull)
  attachments ChatAttachment[]
  notifications ChatNotification[]
  audit_logs  ChatAuditLog[]

  @@index([channel_id, created_at])
}

enum ChatAuditAction {
  EDIT
  DELETE
}

model ChatAuditLog {
  id          String   @id @default(uuid())
  message_id  String
  actor_id    String
  action      ChatAuditAction
  old_content String?  @db.Text
  new_content String?  @db.Text
  reason      String?
  created_at  DateTime @default(now())

  message     ChatMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
  actor       User        @relation(fields: [actor_id], references: [id], onDelete: Cascade)

  @@index([message_id])
  @@index([actor_id])
}

model ChatAttachment {
  id          String   @id @default(uuid())
  message_id  String
  file_name   String
  file_type   String
  file_size   Int
  url         String
  created_at  DateTime @default(now())

  message     ChatMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
}

model ChatNotification {
  id          String   @id @default(uuid())
  user_id     String
  message_id  String
  channel_id  String
  is_sent     Boolean  @default(false)
  created_at  DateTime @default(now())

  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  message     ChatMessage @relation(fields: [message_id], references: [id], onDelete: Cascade)
  channel     ChatChannel @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_sent])
}

model AdminAiChat {
  id           String   @id @default(uuid())
  user_id      String
  title        String
  provider     String
  model_id     String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  last_used_at DateTime @default(now())
  
  messages     AdminAiChatMessage[]
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model AdminAiChatMessage {
  id        String   @id @default(uuid())
  chat_id   String
  role      String   // "user" | "assistant"
  content   String   @db.Text
  images    String[] @default([]) // Array of image URLs/base64
  created_at DateTime @default(now())
  
  chat      AdminAiChat @relation(fields: [chat_id], references: [id], onDelete: Cascade)

  @@index([chat_id, created_at])
}
